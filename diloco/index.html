<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>(Streaming) DiLoCo Simulator</title>
    <style>
        :root {
            /* Color Palette */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;

            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-200: #bfdbfe;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;
            --blue-900: #1e3a8a;

            --green-50: #f0fdf4;
            --green-100: #dcfce7;
            --green-200: #bbf7d0;
            --green-400: #4ade80;
            --green-600: #16a34a;
            --green-800: #166534;

            --indigo-500: #6366f1;
            --purple-200: #e9d5ff;
            --purple-500: #a855f7;
            --purple-600: #9333ea;
            --red-500: #ef4444;
            --orange-600: #ea580c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--slate-800);
            line-height: 1.5;
            margin: 0;
            padding: 2rem;
        }

        /* Layout */
        .container {
            max-width: 64rem;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--slate-200);
            padding-bottom: 1rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--blue-600);
            margin: 0;
        }

        .header p {
            font-size: 0.875rem;
            color: var(--slate-500);
            margin-top: 0.5rem;
        }
        
        .header a {
            color: var(--blue-500);
            text-decoration: none;
        }
        .header a:hover {
            text-decoration: underline;
        }

        .grid-2-cols {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 1024px) {
            .grid-2-cols {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Panels */
        .panel {
            background-color: var(--bg-card);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--slate-100);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .results-panel {
            background-color: var(--blue-50);
            border: 1px solid var(--blue-100);
        }

        /* Typography */
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--slate-700);
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--slate-100);
            padding-bottom: 0.5rem;
        }
        
        .result-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--blue-900);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .label-sm {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--slate-500);
            margin-bottom: 0.25rem;
        }

        .label-sub {
            font-size: 0.65rem;
            color: var(--slate-400);
            margin-top: 0.25rem;
        }

        /* Forms */
        .input-group-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--slate-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: var(--slate-50);
            color: var(--slate-700);
            font-weight: 500;
            box-sizing: border-box;
            outline: none;
        }

        .form-control:focus {
            outline: 2px solid var(--blue-600);
            outline-offset: 1px;
            border-color: var(--blue-600);
        }

        .input-addon-group {
            display: flex;
            align-items: center;
        }
        
        .input-addon-group input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .input-addon {
            background-color: var(--slate-100);
            border: 1px solid var(--slate-300);
            border-left: 0;
            color: var(--slate-500);
            font-size: 0.65rem;
            padding: 0.5rem 0.75rem;
            border-top-right-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            display: flex;
            align-items: center;
            height: 100%;
            box-sizing: border-box;
            line-height: 1.25rem; /* Match input line-height approx */
        }
        
        /* Fix for input height matching */
        .form-control { height: 2.5rem; } 

        .flex-between-center {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Toggle Switch */
        .toggle-container {
            margin-top: 1rem;
            background-color: var(--green-50);
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--green-100);
        }
        
        .toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .toggle-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--green-800);
        }

        .toggle-desc {
            font-size: 0.65rem;
            color: var(--green-600);
            margin-top: 0.125rem;
        }

        .toggle-wrapper {
            position: relative;
            display: inline-block;
            width: 2.5rem;
            height: 1.25rem;
        }

        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .2s;
            border-radius: 9999px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.25rem;
            width: 1.25rem;
            left: 0;
            bottom: 0;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .toggle-checkbox:checked + .toggle-slider {
            background-color: var(--green-400);
        }

        .toggle-checkbox:checked + .toggle-slider:before {
            transform: translateX(100%);
            border-color: var(--green-400);
        }
        
        .streaming-options {
            display: none; /* Hidden by default via JS */
            border-top: 1px solid var(--green-200); 
            padding-top: 0.75rem; 
            margin-top: 0.5rem;
        }
        
        .streaming-options.active {
            display: grid;
        }

        /* Results & Bars */
        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--blue-200);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .result-key {
            font-size: 0.875rem;
            color: var(--blue-900);
        }

        .result-val {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--blue-900);
        }

        .result-val-sm {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--slate-800);
        }

        .bar-group {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }

        .bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: var(--slate-600);
            margin-bottom: 0.25rem;
        }

        .bar-track {
            width: 100%;
            height: 0.375rem;
            background-color: var(--blue-200);
            border-radius: 9999px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill-blue { background-color: var(--blue-600); height: 100%; transition: width 0.3s; }
        .bar-fill-indigo { background-color: var(--indigo-500); height: 100%; transition: width 0.3s; }
        .bar-fill-purple { background-color: var(--purple-500); height: 100%; transition: width 0.3s; }
        .bar-fill-purple-ghost { background-color: var(--purple-200); height: 100%; transition: width 0.3s; }

        .total-row {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--blue-200);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .total-val {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 1.875rem;
            color: var(--blue-700);
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            border-top: 1px solid var(--blue-200);
            padding-top: 0.75rem;
        }

        .tag {
            font-size: 0.65rem;
            font-weight: 400;
            color: var(--slate-400);
            background-color: var(--slate-100);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }

        .line-through { text-decoration: line-through; color: var(--slate-400) !important; }
        .hidden { display: none !important; }

        /* Code Block */
        .code-block {
            background-color: var(--slate-900);
            color: var(--slate-300);
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.75rem;
            overflow-x: auto;
            margin-top: 1.5rem;
        }
        
        .code-title {
            color: var(--slate-100);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            font-size: 0.65rem;
        }

        /* Plot Container */
        .plot-section {
            margin-bottom: 3rem;
            width: 100%;
        }

        .plot-box {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 0.5rem;
            overflow: hidden;
            width: 100%;
            height: 400px;
            box-sizing: border-box;
            padding: 1rem;
        }

        /* Utilities */
        .text-green-400 { color: var(--green-400); }
        .text-blue-400 { color: var(--blue-400); }
        .text-slate-300 { color: var(--slate-300); }
        .text-green-600 { color: var(--green-600); }
        .text-orange-600 { color: var(--orange-600); }
        .text-red-500 { color: var(--red-500); }
        .text-green-500 { color: #22c55e; }
        .font-bold { font-weight: 700; }
        .text-right { text-align: right; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }

        .overlap-detail {
            font-family: monospace;
            font-size: 0.65rem;
            text-align: right;
            background: rgba(255,255,255,0.5);
            padding: 0.25rem;
            border: 1px solid var(--blue-100);
            border-radius: 0.25rem;
            margin-top: 0.25rem;
        }

        /* FAQ */
        .faq-section {
            margin-top: 3rem;
            border-top: 1px solid var(--slate-200);
            padding-top: 2rem;
        }
        .faq-item { margin-bottom: 1.5rem; }
        .faq-q { font-weight: 600; font-size: 0.875rem; color: var(--slate-800); }
        .faq-a { font-size: 0.875rem; color: var(--slate-600); margin-top: 0.25rem; }

        /* Hardware section specific */
        .hardware-box {
            background-color: var(--slate-50);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--slate-200);
        }

        /* Tooltip */
        .tooltip-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .tooltip-bubble {
            visibility: hidden;
            opacity: 0;
            background-color: var(--slate-800);
            color: white;
            text-align: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.75rem;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .tooltip-bubble::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--slate-800) transparent transparent transparent;
        }

        .tooltip-wrapper:hover .tooltip-bubble {
            visibility: visible;
            opacity: 1;
        }

        .form-control:disabled {
            background-color: var(--slate-200);
            color: var(--slate-400);
            cursor: not-allowed;
        }

        /* Save Configuration Button */
        .save-config-btn {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--blue-600);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .save-config-btn:hover {
            background-color: var(--blue-700);
        }

        .save-config-btn:active {
            transform: scale(0.98);
        }

        /* Configuration Cards */
        .config-card {
            background-color: white;
            border: 2px solid var(--blue-200);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.2s;
        }

        .config-card:hover {
            border-color: var(--blue-400);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .config-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--blue-900);
            margin-bottom: 0.25rem;
        }

        .config-util {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--blue-600);
            font-family: 'SF Mono', 'Roboto Mono', monospace;
        }

        .config-params {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--slate-600);
        }

        .config-param {
            display: flex;
            justify-content: space-between;
        }

        .config-param-label {
            color: var(--slate-500);
        }

        .config-param-value {
            font-weight: 600;
            color: var(--slate-700);
            font-family: 'SF Mono', 'Roboto Mono', monospace;
        }

        .delete-config-btn {
            background-color: var(--red-500);
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .delete-config-btn:hover {
            background-color: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--slate-400);
        }

        .empty-state svg {
            margin: 0 auto 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body class="container">

    <header class="header">
        <h1>(Streaming) DiLoCo Simulator</h1>
        <p>
            Vibecoded (<a href="https://github.com/mino98/diloco-calculator" target="_blank">repo</a>) based on the paper trilogy: 
            <a href="https://arxiv.org/abs/2311.08105" target="_blank">DiLoCo</a>, 
            <a href="https://arxiv.org/abs/2501.18512" target="_blank">Streaming DiLoCo</a>, 
            <a href="https://arxiv.org/abs/2503.09799" target="_blank">Scaling Laws</a>
        </p>
    </header>

    <!-- Top Configuration Panel -->
    <div class="panel" style="margin-bottom: 2rem;">
        <h2 class="section-title">Model & Network Configuration</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
                <label class="label-sm">Model Size</label>
                <select id="modelSizeSelect" class="form-control">
                    <option value="1000000000">1B Params</option>
                    <option value="10000000000" selected>10B Params</option>
                    <option value="100000000000">100B Params</option>
                    <option value="1000000000000">1T Params</option>
                </select>
                <div class="label-sub">N (number of parameters)</div>
            </div>

            <div>
                <label class="label-sm">Compute Time per Step</label>
                <input type="text" id="secondsPerStep" value="1.0" class="form-control formatted-input">
                <div class="label-sub">Seconds</div>
            </div>

            <div>
                <label class="label-sm">Number of Datacenters</label>
                <input type="text" id="numDatacenters" value="2" class="form-control formatted-input">
                <div class="label-sub">M (≥1)</div>
            </div>

            <div>
                <label class="label-sm">Bandwidth Between DCs</label>
                <div class="input-addon-group">
                    <input type="text" id="interBw" value="100" class="form-control formatted-input">
                    <span class="input-addon">Gbps</span>
                </div>
                <div class="label-sub">B (inter-DC bandwidth)</div>
            </div>
        </div>
    </div>

    <div class="grid-2-cols">

        <!-- Input Section -->
        <div class="panel">

            <div>
                <h2 class="section-title">DiLoCo Parameters</h2>

                <div class="mb-4">
                    <label class="label-sm">Synchronization Cadence (H)</label>
                    <input type="text" id="syncCadence" value="30" class="form-control formatted-input">
                    <div class="label-sub">Steps between syncs (H=1: Data-Parallel)</div>
                </div>

                <div class="mb-4">
                    <label class="label-sm">Gradients Data Type</label>
                    <select id="dtypeSelect" class="form-control">
                        <option value="2" selected>bfloat16 (2 bytes)</option>
                        <option value="1">int8 (1 byte)</option>
                        <option value="0.5">int4 (0.5 bytes)</option>
                    </select>
                    <div class="label-sub">Affects communication size</div>
                </div>

                <div class="mb-4">
                    <label class="label-sm">Overlapping Steps (S)</label>
                    <input type="text" id="staleness" value="0" class="form-control formatted-input">
                    <div class="label-sub">S=0: Sequential, S>0: Streaming</div>
                </div>

                <div class="mb-4">
                    <label class="label-sm">Number of Fragments (P)</label>
                    <input type="text" id="fragments" value="1" class="form-control formatted-input">
                    <div class="label-sub">P=1: Single send, P>1: Streaming</div>
                </div>
            </div>

            <!-- Save Configuration Section -->
            <div style="border-top: 2px solid var(--slate-200); padding-top: 1rem;">
                <h2 class="section-title">Save Configuration</h2>
                <div class="mb-2">
                    <label class="label-sm">Configuration Name</label>
                    <input type="text" id="configName" value="" placeholder="e.g., High bandwidth setup" class="form-control">
                </div>
                <button id="saveConfigBtn" class="save-config-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 0.5rem;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Configuration
                </button>
            </div>

        </div>

        <!-- Saved Configurations Section (Right Column) -->
        <div class="panel results-panel">
            <h2 class="result-title">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                Saved Configurations
            </h2>

            <div id="configsList">
                <div class="empty-state">
                    <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 1;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <p style="font-size: 0.875rem; margin: 0;">No configurations saved yet</p>
                    <p style="font-size: 0.75rem; margin-top: 0.5rem;">Configure your settings on the left and click "Add Configuration"</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Figure 4 Plot -->
    <div class="plot-section">
        <h3 class="section-title" style="border:0; margin-bottom: 1rem;">Compute Utilization plot (Figure 4 of the Streaming DiLoCo paper)</h3>
        <div id="figure4Plot" class="plot-box">
            <!-- Chart injected here -->
        </div>
    </div>

    <!-- FAQ Section -->
    <div class="faq-section">
        <h2 class="section-title" style="border:0;">Frequently Asked Questions</h2>
        
        <div class="faq-item">
            <div class="faq-q">1. Source / Citation</div>
            <div class="faq-a">
                Based on <strong>Appendix A.2</strong> and <strong>A.3</strong> of <em>"Communication-Efficient Language Model Training Scales Reliably and Robustly"</em>.
                Model assumes <strong>bfloat16</strong> precision.
            </div>
        </div>

        <div class="faq-item">
            <div class="faq-q">2. Wouldn't a real-world implementation of Streaming Diloco need some form of Hierarchical All-Reduce?</div>
            <div class="faq-a">
                I think so, most likely. Real-world implementations typically use hierarchical collectives.
                However, the <strong>Scaling Laws paper</strong> explicitly models the time using the standard flat ring lower bound ($T \approx 2N/W$). This implies that if the Inter-DC link is the bottleneck, the total transfer time is governed by that bottleneck bandwidth ($W$) regardless of the reduction topology.
            </div>
        </div>

        <div class="faq-item">
            <div class="faq-q">3. What are Staleness (S) and Fragments (P)?</div>
            <div class="faq-a">
                <strong>Fragments (P):</strong> Streaming DiLoCo breaks the outer sync payload into $P$ chunks. While this doesn't change the <em>total</em> bytes sent, it allows for finer-grained overlap and lower memory overhead for buffers. <br>
                <strong>Staleness (S):</strong> By allowing the outer optimizer to be $S$ steps stale, the communication of gradients can be spread over $S$ intervals of length $H$. This effectively reduces the bandwidth requirement by a factor of $S$ (or allows using a link $S$ times slower without bottlenecking).
            </div>
        </div>

        <div class="faq-item">
            <div class="faq-q">4. Why is "Bandwidth (Per Chip)" used in the formulas?</div>
            <div class="faq-a">
                <p style="margin-bottom: 0.5rem;">
                    The training time calculation uses the bandwidth-optimal All-Reduce cost model from <em>Patarasuk & Yuan (2009)</em>, approximated in the paper as <code>T ≈ 2N / W</code>.
                    In this formula, <strong>W</strong> represents the per-chip link bandwidth.
                </p>
                <p>
                    However, the <strong>"Inter-DC Capacity"</strong> metric displayed in the results represents the <strong>aggregate cross-sectional bandwidth</strong> that would be required if every chip in the datacenter saturated its Inter-DC link simultaneously. It is calculated as <code>Bandwidth_Per_Chip × (R / M)</code>.
                </p>
            </div>
        </div>
        
        <div class="faq-item">
            <div class="faq-q">5. Why do Vanilla and Streaming DiLoCo lines overlap?</div>
            <div class="faq-a">
                In the simulator's model, Streaming DiLoCo sends the same <strong>total amount of data</strong> as Vanilla DiLoCo, just in smaller chunks. 
                The only difference is the added latency overhead of sending multiple fragments ($P \times \epsilon$). 
                For large models (e.g., 100B params), the bandwidth transfer time (tens of seconds) massively dominates the latency overhead (milliseconds), making the lines appear identical on the plot. 
                To see them diverge, try increasing the <strong>Fragments</strong> count or the <strong>Inter-DC Latency</strong>.
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--slate-200); text-align: center; color: var(--slate-500); font-size: 0.875rem;">
        <p>
            Originally forked from <a href="https://mino98.github.io/diloco-calculator/" target="_blank" style="color: var(--blue-500); text-decoration: none;">mino98's DiLoCo Calculator</a>
        </p>
    </footer>

    <!-- Hidden fields for fixed parameters -->
    <input type="hidden" id="totalSteps" value="1000">
    <input type="hidden" id="totalChips" value="100">

<script>
    // Constants for Scaling Laws (Table 10)
    const SCALING_BATCH_A = 0.00709;
    const SCALING_BATCH_ALPHA = 0.4695;
    const SCALING_BATCH_BETA = 0.3399;
    const SEQ_LEN = 2048; 

    const SCALING_LOSS_A = 19.226;
    const SCALING_LOSS_ALPHA = -0.0985;
    const SCALING_LOSS_BETA = 0.0116;

    // Input Formatting Logic
    const formatNumber = (num) => {
        if (!num && num !== 0) return '';
        const cleanStr = num.toString().replace(/,/g, '');
        const val = parseFloat(cleanStr);
        if (isNaN(val)) return cleanStr;
        return val.toLocaleString('en-US');
    };

    const parseNumber = (str) => {
        if (!str) return 0;
        return parseFloat(str.replace(/,/g, '')) || 0;
    };

    function formatCapacity(bps) {
        const gbps = bps / 1e9;
        if (gbps < 1000) {
            return gbps.toFixed(1) + " Gbps";
        }
        const tbps = gbps / 1000;
        if (tbps < 1000) {
            return tbps.toFixed(2) + " Tbps";
        }
        const pbps = tbps / 1000;
        return pbps.toFixed(2) + " Pbps";
    }

    // Attach listeners
    document.querySelectorAll('.formatted-input').forEach(input => {
        input.value = formatNumber(input.value);
        input.addEventListener('focus', function() {
            this.value = this.value.replace(/,/g, '');
            this.select();
        });
        input.addEventListener('blur', function() {
            this.value = formatNumber(this.value);
        });
        input.addEventListener('input', updatePlot);
    });

    // Model Size Dropdown
    document.getElementById('modelSizeSelect').addEventListener('change', updatePlot);

    // Wire up all input listeners
    document.getElementById('numDatacenters').addEventListener('input', () => {
        updateFieldStates();
        updatePlot();
    });
    document.getElementById('syncCadence').addEventListener('input', () => {
        updateFieldStates();
        updatePlot();
    });
    document.getElementById('dtypeSelect').addEventListener('change', updatePlot);
    document.getElementById('staleness').addEventListener('input', () => {
        updateFieldStates();
        updatePlot();
    });
    document.getElementById('fragments').addEventListener('input', () => {
        updateFieldStates();
        updatePlot();
    });

    // Handle field state logic
    const stalenessInput = document.getElementById('staleness');
    const fragmentsInput = document.getElementById('fragments');
    const syncCadenceInput = document.getElementById('syncCadence');

    function updateFieldStates() {
        const H = parseNumber(syncCadenceInput.value);

        // If H == 1 (Data-Parallel), disable S and P
        if (H === 1) {
            stalenessInput.disabled = true;
            fragmentsInput.disabled = true;
        } else {
            stalenessInput.disabled = false;
            fragmentsInput.disabled = false;
        }
    }

    // Initial check on page load
    updateFieldStates();

    function formatTime(seconds) {
        if (seconds < 0) return "0s";
        if (seconds < 60) return seconds.toFixed(1) + "s";
        const d = Math.floor(seconds / (3600 * 24));
        const h = Math.floor((seconds % (3600 * 24)) / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);

        if (d > 0) return `${d}d ${h}h ${m}m`;
        if (h > 0) return `${h}h ${m}m ${s}s`;
        return `${m}m ${s}s`;
    }

    function calculateCore(overrideInterBw) {
        // Fetch values
        const N = parseFloat(document.getElementById('modelSizeSelect').value);
        const T = parseNumber(document.getElementById('totalSteps').value);
        const secondsPerStep = parseNumber(document.getElementById('secondsPerStep').value);
        const M = parseNumber(document.getElementById('numDatacenters').value);
        const H = parseNumber(document.getElementById('syncCadence').value);
        const bytesPerParam = parseFloat(document.getElementById('dtypeSelect').value);
        const S = parseNumber(document.getElementById('staleness').value);
        const P = parseNumber(document.getElementById('fragments').value);

        // Override bandwidth if running sweep
        const B_gbps = overrideInterBw !== undefined ? overrideInterBw : parseNumber(document.getElementById('interBw').value);

        if (M < 1) return { error: "M must be >= 1" };
        if (H < 1) return { error: "H must be >= 1" };

        // Data size in bytes
        const D = N * bytesPerParam;

        // Convert bandwidth from Gbps to bytes/second: Gbps * 1e9 / 8
        const B_bytes_per_sec = B_gbps * 1e9 / 8;

        // Time calculations
        const T_comp = secondsPerStep * T;

        // Communication time per synchronization using new formula:
        // T_comm_per_sync = 2 * (1 - 1/M) * D / B
        let T_comm_per_sync = 0;
        if (M > 1) {
            T_comm_per_sync = 2 * (1 - 1/M) * D / B_bytes_per_sec;
        }

        // Total communication time across all syncs
        const num_syncs = T / H;
        const T_comm_inter = T_comm_per_sync * num_syncs;

        // Determine mode and calculate total time
        let T_total;
        let overlapState = "sequential";
        let mode = "Data-Parallel";

        if (H === 1) {
            // Data-Parallel mode
            T_total = T_comp + T_comm_inter;
            overlapState = "data_parallel";
            mode = "Data-Parallel";
        } else if (S > 0 || P > 1) {
            // Streaming DiLoCo mode
            mode = "Streaming DiLoCo";

            // With overlapping, communication can be hidden behind computation
            // We assume perfect overlap up to the computation window
            const effective_staleness = Math.max(S, 1);
            const T_outer_effective = T_comm_inter / effective_staleness;

            if (T_outer_effective <= T_comp) {
                T_total = T_comp;
                overlapState = "hidden";
            } else {
                T_total = T_outer_effective;
                overlapState = "bound";
            }
        } else {
            // Standard DiLoCo mode
            mode = "DiLoCo";
            T_total = T_comp + T_comm_inter;
        }

        const utilization = (T_comp / T_total) * 100;

        return {
            T, T_comp, T_comm_inter, T_total, utilization, overlapState,
            N, M, H, bytesPerParam, S, P, B_gbps, mode
        };
    }

    // Configuration Storage
    let savedConfigurations = [];

    // Save Configuration
    function saveConfiguration() {
        const configName = document.getElementById('configName').value.trim();

        if (!configName) {
            alert('Please enter a configuration name');
            return;
        }

        const res = calculateCore();
        if (res.error) {
            alert('Error calculating configuration: ' + res.error);
            return;
        }

        const config = {
            id: Date.now(),
            name: configName,
            params: {
                N: res.N,
                secondsPerStep: parseNumber(document.getElementById('secondsPerStep').value),
                M: res.M,
                H: res.H,
                bytesPerParam: res.bytesPerParam,
                S: res.S,
                P: res.P,
                B_gbps: res.B_gbps
            },
            results: res
        };

        savedConfigurations.push(config);
        renderConfigurations();

        // Clear the name input
        document.getElementById('configName').value = '';
    }

    // Delete Configuration
    function deleteConfiguration(id) {
        savedConfigurations = savedConfigurations.filter(c => c.id !== id);
        renderConfigurations();
    }

    // Render Configurations
    function renderConfigurations() {
        const container = document.getElementById('configsList');

        if (savedConfigurations.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="stroke-width: 1;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <p style="font-size: 0.875rem; margin: 0;">No configurations saved yet</p>
                    <p style="font-size: 0.75rem; margin-top: 0.5rem;">Configure your settings on the left and click "Add Configuration"</p>
                </div>
            `;
            return;
        }

        let html = '';
        savedConfigurations.forEach(config => {
            const p = config.params;
            const r = config.results;

            // Format dtype
            let dtypeStr = 'bf16';
            if (p.bytesPerParam === 1) dtypeStr = 'int8';
            else if (p.bytesPerParam === 0.5) dtypeStr = 'int4';

            html += `
                <div class="config-card">
                    <div class="config-header">
                        <div style="flex: 1;">
                            <div class="config-name">${config.name}</div>
                            <div style="font-size: 0.7rem; color: var(--slate-400); margin-top: 0.125rem;">${r.mode}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="config-util">${r.utilization.toFixed(1)}%</div>
                            <div style="font-size: 0.65rem; color: var(--slate-500); margin-top: 0.125rem;">Compute Util.</div>
                        </div>
                    </div>

                    <div style="font-size: 0.7rem; color: var(--slate-600); margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <span><strong>H:</strong> ${p.H}</span>
                        <span>•</span>
                        <span><strong>dtype:</strong> ${dtypeStr}</span>
                        <span>•</span>
                        <span><strong>S:</strong> ${p.S}</span>
                        <span>•</span>
                        <span><strong>P:</strong> ${p.P}</span>
                    </div>

                    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--blue-100); display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;">
                        <div>
                            <div style="color: var(--slate-500);">Total Time:</div>
                            <div style="font-weight: 700; color: var(--blue-700); font-family: monospace;">${formatTime(r.T_total)}</div>
                        </div>
                        <button class="delete-config-btn" onclick="deleteConfiguration(${config.id})">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Remove
                        </button>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Save Config Button
    document.getElementById('saveConfigBtn').addEventListener('click', saveConfiguration);

    function updatePlot() {
        const container = document.getElementById('figure4Plot');
        if(!container) return;

        // Use direct container dimensions from DOM
        const width = container.clientWidth || 600;
        const height = 400; // Hardcoded fixed height to prevent vertical compression
        const padding = { top: 20, right: 20, bottom: 40, left: 50 }; 
        
        // Get base config (except Inter-DC BW which we sweep)
        const N = parseFloat(document.getElementById('modelSizeSelect').value);
        const secondsPerStep = parseNumber(document.getElementById('secondsPerStep').value);
        const H = parseNumber(document.getElementById('syncCadence').value);
        const M = parseNumber(document.getElementById('numDatacenters').value);
        const bytesPerParam = parseFloat(document.getElementById('dtypeSelect').value);
        const S = parseNumber(document.getElementById('staleness').value);
        const P = parseNumber(document.getElementById('fragments').value);

        // Data sizes for different dtypes
        const D = N * bytesPerParam;
        const D_int8 = N * 1;
        const D_int4 = N * 0.5;

        // Per-Step calculations
        const T_comp_step = secondsPerStep;

        // Baseline time per step (just compute now)
        const T_baseline_step = T_comp_step;

        // Time for H steps (Inner Loop)
        const T_inner_phase = T_baseline_step * H; 

        // Sweep Configuration: 0.1G to 1000G
        const bwPoints = [];
        for (let exp = -1; exp <= 3; exp += 0.1) {
            bwPoints.push(Math.pow(10, exp));
        }

        // Series Definitions
        const seriesConfig = [
            { name: "Data Parallel (H=1)", color: "#94a3b8" }, // Grey
            { name: "DiLoCo", color: "#ef4444" }, // Red
            { name: "Streaming DiLoCo", color: "#f97316" }, // Orange
            { name: "Streaming + Overlap", color: "#3b82f6" }, // Blue
            { name: "Streaming + Overlap + int8", color: "#10b981" } // Green
        ];

        const seriesData = seriesConfig.map(() => []);

        bwPoints.forEach(bw => {
            const B_bytes_per_sec = bw * 1e9 / 8;

            // Helper to get communication time per sync using new formula
            const getCommTime = (data_bytes, num_dcs) => {
                if (num_dcs <= 1) return 0;
                return 2 * (1 - 1/num_dcs) * data_bytes / B_bytes_per_sec;
            };

            // Comm times per sync for different configurations
            const comm_per_sync = getCommTime(D, M);
            const comm_per_sync_int8 = getCommTime(D_int8, M);
            const comm_per_sync_int4 = getCommTime(D_int4, M);

            // 1. Data Parallel (H=1)
            const T_dp_step = T_baseline_step + comm_per_sync;
            const util_dp = (T_comp_step / T_dp_step) * 100;

            // 2. Vanilla DiLoCo (H>1, no overlap)
            const T_vanilla_cycle = T_inner_phase + comm_per_sync;
            const util_vanilla = ((T_comp_step * H) / T_vanilla_cycle) * 100;

            // 3. Streaming (Sequential with fragments)
            // No real overlap, but broken into fragments
            const T_streaming_cycle = T_vanilla_cycle;
            const util_streaming = ((T_comp_step * H) / T_streaming_cycle) * 100;

            // 4. Streaming + Overlap (S>0)
            const effective_staleness = Math.max(S, 1);
            const T_overlap_cycle = Math.max(T_inner_phase, comm_per_sync / effective_staleness);
            const util_overlap = ((T_comp_step * H) / T_overlap_cycle) * 100;

            // 5. Streaming + Overlap + int8
            const T_overlap_int8_cycle = Math.max(T_inner_phase, comm_per_sync_int8 / effective_staleness);
            const util_overlap_int8 = ((T_comp_step * H) / T_overlap_int8_cycle) * 100;

            seriesData[0].push({ x: bw, y: util_dp });
            seriesData[1].push({ x: bw, y: util_vanilla });
            seriesData[2].push({ x: bw, y: util_streaming });
            seriesData[3].push({ x: bw, y: util_overlap });
            seriesData[4].push({ x: bw, y: util_overlap_int8 });
        });

        // SVG Drawing
        let svg = `<svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg" style="font-family: sans-serif; font-size: 0.75rem;">`;
        svg += `<rect width="100%" height="100%" fill="white" />`;

        const minX = Math.log(0.1);
        const maxX = Math.log(1000);
        const scaleX = (val) => padding.left + ((Math.log(val) - minX) / (maxX - minX)) * (width - padding.left - padding.right);
        const scaleY = (val) => height - padding.bottom - (val / 100) * (height - padding.top - padding.bottom);

        // Grid & Y Axis
        for (let i = 0; i <= 100; i += 20) {
            const y = scaleY(i);
            svg += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#e2e8f0" />`;
            svg += `<text x="${padding.left - 5}" y="${y + 3}" text-anchor="end" fill="#64748b">${i}%</text>`;
        }
        
        // X Axis & Grid (Logarithmic)
        const majorTicks = [0.1, 1, 10, 100, 1000];
        const labels = ["10⁻¹", "10⁰", "10¹", "10²", "10³"];
        
        // Minor grid lines
        for (let i = -1; i < 3; i++) {
            const base = Math.pow(10, i);
            for (let j = 2; j < 10; j++) {
                const val = base * j;
                const x = scaleX(val);
                svg += `<line x1="${x}" y1="${height - padding.bottom}" x2="${x}" y2="${padding.top}" stroke="#f1f5f9" />`;
            }
        }

        majorTicks.forEach((val, i) => {
            const x = scaleX(val);
            svg += `<line x1="${x}" y1="${height - padding.bottom}" x2="${x}" y2="${padding.top}" stroke="#cbd5e1" stroke-dasharray="4" />`;
            svg += `<text x="${x}" y="${height - padding.bottom + 15}" text-anchor="middle" fill="#64748b">${labels[i]}</text>`;
        });

        svg += `<text x="${width/2}" y="${height-5}" text-anchor="middle" fill="#475569" font-weight="bold">Inter-DC Bandwidth (Gbps)</text>`;
        svg += `<text x="${15}" y="${height/2}" text-anchor="middle" fill="#475569" font-weight="bold" transform="rotate(-90, 15, ${height/2})">Compute Utilization</text>`;

        // Paths
        seriesData.forEach((points, i) => {
            const pathD = points.map((p, idx) => `${idx === 0 ? 'M' : 'L'} ${scaleX(p.x)} ${scaleY(p.y)}`).join(' ');
            const dash = i === 2 ? 'stroke-dasharray="4,2"' : ''; 
            svg += `<path d="${pathD}" fill="none" stroke="${seriesConfig[i].color}" stroke-width="2" ${dash} />`;
        });

        // Legend (Top Left)
        const legendX = padding.left + 15;
        const legendY = padding.top + 10;
        
        // Legend Background
        svg += `<rect x="${legendX - 5}" y="${legendY - 5}" width="180" height="${seriesConfig.length * 15 + 10}" fill="rgba(255,255,255,0.9)" stroke="#e2e8f0" rx="4" />`;

        seriesData.forEach((points, i) => {
            const legY = legendY + i * 15;
            const dash = i === 2 ? 'stroke-dasharray="4,2"' : ''; 
            svg += `<line x1="${legendX}" y1="${legY+5}" x2="${legendX+15}" y2="${legY+5}" stroke="${seriesConfig[i].color}" stroke-width="2" ${dash} />`;
            svg += `<text x="${legendX + 20}" y="${legY + 9}" fill="#475569" style="font-size: 10px; font-weight: 500;">${seriesConfig[i].name}</text>`;
        });

        svg += `</svg>`;
        container.innerHTML = svg;
    }

    // Initial plot render
    updatePlot();

    // Make deleteConfiguration available globally
    window.deleteConfiguration = deleteConfiguration;
</script>

</body>
</html>