<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>(Streaming) DiLoCo Simulator</title>
    <style>
        :root {
            /* Color Palette */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;

            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-200: #bfdbfe;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;
            --blue-900: #1e3a8a;

            --green-50: #f0fdf4;
            --green-100: #dcfce7;
            --green-200: #bbf7d0;
            --green-400: #4ade80;
            --green-600: #16a34a;
            --green-800: #166534;

            --indigo-500: #6366f1;
            --purple-200: #e9d5ff;
            --purple-500: #a855f7;
            --purple-600: #9333ea;
            --red-500: #ef4444;
            --orange-600: #ea580c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--slate-800);
            line-height: 1.5;
            margin: 0;
            padding: 2rem;
        }

        /* Layout */
        .container {
            max-width: 64rem;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--slate-200);
            padding-bottom: 1rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--blue-600);
            margin: 0;
        }

        .header p {
            font-size: 0.875rem;
            color: var(--slate-500);
            margin-top: 0.5rem;
        }
        
        .header a {
            color: var(--blue-500);
            text-decoration: none;
        }
        .header a:hover {
            text-decoration: underline;
        }

        .grid-2-cols {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 1024px) {
            .grid-2-cols {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Panels */
        .panel {
            background-color: var(--bg-card);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--slate-100);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .results-panel {
            background-color: var(--blue-50);
            border: 1px solid var(--blue-100);
        }

        /* Typography */
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--slate-700);
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--slate-100);
            padding-bottom: 0.5rem;
        }
        
        .result-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--blue-900);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .label-sm {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--slate-500);
            margin-bottom: 0.25rem;
        }

        .label-sub {
            font-size: 0.65rem;
            color: var(--slate-400);
            margin-top: 0.25rem;
        }

        /* Forms */
        .input-group-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--slate-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: var(--slate-50);
            color: var(--slate-700);
            font-weight: 500;
            box-sizing: border-box;
            outline: none;
        }

        .form-control:focus {
            outline: 2px solid var(--blue-600);
            outline-offset: 1px;
            border-color: var(--blue-600);
        }

        .input-addon-group {
            display: flex;
            align-items: center;
        }
        
        .input-addon-group input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .input-addon {
            background-color: var(--slate-100);
            border: 1px solid var(--slate-300);
            border-left: 0;
            color: var(--slate-500);
            font-size: 0.65rem;
            padding: 0.5rem 0.75rem;
            border-top-right-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            display: flex;
            align-items: center;
            height: 100%;
            box-sizing: border-box;
            line-height: 1.25rem; /* Match input line-height approx */
        }
        
        /* Fix for input height matching */
        .form-control { height: 2.5rem; } 

        .flex-between-center {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Toggle Switch */
        .toggle-container {
            margin-top: 1rem;
            background-color: var(--green-50);
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--green-100);
        }
        
        .toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .toggle-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--green-800);
        }

        .toggle-desc {
            font-size: 0.65rem;
            color: var(--green-600);
            margin-top: 0.125rem;
        }

        .toggle-wrapper {
            position: relative;
            display: inline-block;
            width: 2.5rem;
            height: 1.25rem;
        }

        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .2s;
            border-radius: 9999px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.25rem;
            width: 1.25rem;
            left: 0;
            bottom: 0;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .toggle-checkbox:checked + .toggle-slider {
            background-color: var(--green-400);
        }

        .toggle-checkbox:checked + .toggle-slider:before {
            transform: translateX(100%);
            border-color: var(--green-400);
        }
        
        .streaming-options {
            display: none; /* Hidden by default via JS */
            border-top: 1px solid var(--green-200); 
            padding-top: 0.75rem; 
            margin-top: 0.5rem;
        }
        
        .streaming-options.active {
            display: grid;
        }

        /* Results & Bars */
        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--blue-200);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .result-key {
            font-size: 0.875rem;
            color: var(--blue-900);
        }

        .result-val {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--blue-900);
        }

        .result-val-sm {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--slate-800);
        }

        .bar-group {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }

        .bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: var(--slate-600);
            margin-bottom: 0.25rem;
        }

        .bar-track {
            width: 100%;
            height: 0.375rem;
            background-color: var(--blue-200);
            border-radius: 9999px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill-blue { background-color: var(--blue-600); height: 100%; transition: width 0.3s; }
        .bar-fill-indigo { background-color: var(--indigo-500); height: 100%; transition: width 0.3s; }
        .bar-fill-purple { background-color: var(--purple-500); height: 100%; transition: width 0.3s; }
        .bar-fill-purple-ghost { background-color: var(--purple-200); height: 100%; transition: width 0.3s; }

        .total-row {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--blue-200);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .total-val {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 1.875rem;
            color: var(--blue-700);
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            border-top: 1px solid var(--blue-200);
            padding-top: 0.75rem;
        }

        .tag {
            font-size: 0.65rem;
            font-weight: 400;
            color: var(--slate-400);
            background-color: var(--slate-100);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }

        .line-through { text-decoration: line-through; color: var(--slate-400) !important; }
        .hidden { display: none !important; }

        /* Code Block */
        .code-block {
            background-color: var(--slate-900);
            color: var(--slate-300);
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.75rem;
            overflow-x: auto;
            margin-top: 1.5rem;
        }
        
        .code-title {
            color: var(--slate-100);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            font-size: 0.65rem;
        }

        /* Plot Container */
        .plot-section {
            margin-bottom: 3rem;
            width: 100%;
        }

        .plot-box {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 0.5rem;
            overflow: hidden;
            width: 100%;
            height: 400px;
            box-sizing: border-box;
            padding: 1rem;
        }

        /* Utilities */
        .text-green-400 { color: var(--green-400); }
        .text-blue-400 { color: var(--blue-400); }
        .text-slate-300 { color: var(--slate-300); }
        .text-green-600 { color: var(--green-600); }
        .text-orange-600 { color: var(--orange-600); }
        .text-red-500 { color: var(--red-500); }
        .text-green-500 { color: #22c55e; }
        .font-bold { font-weight: 700; }
        .text-right { text-align: right; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }

        .overlap-detail {
            font-family: monospace;
            font-size: 0.65rem;
            text-align: right;
            background: rgba(255,255,255,0.5);
            padding: 0.25rem;
            border: 1px solid var(--blue-100);
            border-radius: 0.25rem;
            margin-top: 0.25rem;
        }

        /* FAQ */
        .faq-section {
            margin-top: 3rem;
            border-top: 1px solid var(--slate-200);
            padding-top: 2rem;
        }
        .faq-item { margin-bottom: 1.5rem; }
        .faq-q { font-weight: 600; font-size: 0.875rem; color: var(--slate-800); }
        .faq-a { font-size: 0.875rem; color: var(--slate-600); margin-top: 0.25rem; }

        /* Hardware section specific */
        .hardware-box {
            background-color: var(--slate-50); 
            padding: 1rem; 
            border-radius: 0.5rem; 
            border: 1px solid var(--slate-200);
        }
    </style>
</head>
<body class="container">

    <header class="header">
        <h1>(Streaming) DiLoCo Simulator</h1>
        <p>
            Vibecoded (<a href="https://github.com/mino98/diloco-calculator" target="_blank">repo</a>) based on the paper trilogy: 
            <a href="https://arxiv.org/abs/2311.08105" target="_blank">DiLoCo</a>, 
            <a href="https://arxiv.org/abs/2501.18512" target="_blank">Streaming DiLoCo</a>, 
            <a href="https://arxiv.org/abs/2503.09799" target="_blank">Scaling Laws</a>
        </p>
    </header>

    <div class="grid-2-cols">
        
        <!-- Input Section -->
        <div class="panel">
            
            <div>
                <h2 class="section-title">Model & Data</h2>
                
                <!-- Model Size Preset -->
                <div class="mb-2">
                    <label class="label-sm">Model Size</label>
                    <select id="modelSizeSelect" class="form-control">
                        <option value="10000000">10M Params</option>
                        <option value="50000000">50M Params</option>
                        <option value="100000000">100M Params</option>
                        <option value="500000000">500M Params</option>
                        <option value="1000000000">1B Params</option>
                        <option value="5000000000">5B Params</option>
                        <option value="10000000000" selected>10B Params</option>
                        <option value="50000000000">50B Params</option>
                        <option value="100000000000">100B Params</option>
                        <option value="500000000000">500B Params</option>
                    </select>
                    <div class="label-sub">N, assumes bfloat16</div>
                </div>

                <div class="mb-2">
                    <label class="label-sm">Token Budget</label>
                    <input type="text" id="tokenBudget" value="200,000,000,000" class="form-control formatted-input">
                    <div class="label-sub">D (Default: 20 × N)</div>
                </div>
                
                <div class="mb-2">
                    <div class="flex-between-center">
                        <label class="label-sm">Global Batch Size (Tokens)</label>
                        <span id="batchSuggestion" class="label-sm" style="color: var(--blue-500); cursor: pointer; display: none;" onclick="applyBatchSuggestion()">Use suggested: <span id="batchSuggestionVal"></span></span>
                    </div>
                    <input type="text" id="batchSize" value="910,534" class="form-control formatted-input">
                    <div class="label-sub">B (Recommended: <span id="batchRecVal">...</span> based on Table 10)</div>
                </div>
            </div>

            <div>
                <h2 class="section-title">DiLoCo Parameters</h2>
                <div class="input-group-grid">
                    <div>
                        <label class="label-sm">Replicas (M)</label>
                        <input type="text" id="replicas" value="2" class="form-control formatted-input">
                        <div class="label-sub">Must be ≥ 2</div>
                    </div>
                    <div>
                        <label class="label-sm">Sync Cadence (H)</label>
                        <input type="text" id="syncCadence" value="30" class="form-control formatted-input">
                        <div class="label-sub">Inner steps</div>
                    </div>
                </div>

                <!-- Streaming Toggle -->
                <div class="toggle-container">
                    <div class="toggle-header">
                        <div>
                            <div class="toggle-title">Use Streaming DiLoCo</div>
                            <div class="toggle-desc">Overlap Inter-DC comms with computation</div>
                        </div>
                        <div class="toggle-wrapper">
                            <input type="checkbox" id="streamingToggle" checked class="toggle-checkbox"/>
                            <label for="streamingToggle" class="toggle-slider"></label>
                        </div>
                    </div>
                    
                    <!-- Streaming Options (Hidden by default) -->
                    <div id="streamingOptions" class="streaming-options input-group-grid active">
                        <div>
                            <label class="label-sm" style="color: var(--green-800);">Staleness (S)</label>
                            <input type="text" id="staleness" value="1" class="form-control formatted-input" style="border-color: var(--green-400);">
                            <div class="label-sub" style="color: var(--green-600);">Overlapping steps (1..10)</div>
                        </div>
                        <div>
                            <label class="label-sm" style="color: var(--green-800);">Fragments (P)</label>
                            <input type="text" id="fragments" value="16" class="form-control formatted-input" style="border-color: var(--green-400);">
                            <div class="label-sub" style="color: var(--green-600);">Chunks per sync</div>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="section-title">Hardware & Network</h2>
                <div class="input-group-grid mb-4">
                    <div>
                        <label class="label-sm">Total Chips (R)</label>
                        <input type="text" id="totalChips" value="100" class="form-control formatted-input">
                    </div>
                    <div>
                        <label class="label-sm">Chip Type (Est. Effective TFLOPS)</label>
                        <select id="flopsPerChip" class="form-control">
                            <optgroup label="NVIDIA GPUs">
                                <option value="156">NVIDIA A100 (156 TFLOPS)</option>
                                <option value="495" selected>NVIDIA H100 (495 TFLOPS)</option>
                                <option value="1125">NVIDIA B200 (1125 TFLOPS)</option>
                            </optgroup>
                            <optgroup label="Google TPUs">
                                <option value="138">TPU v4 (138 TFLOPS)</option>
                                <option value="100">TPU v5e (100 TFLOPS)</option>
                                <option value="230">TPU v5p (230 TFLOPS)</option>
                                <option value="408">TPU v6e (408 TFLOPS)</option>
                            </optgroup>
                            <optgroup label="AWS Trainium">
                                <option value="95">Trainium 1 (95 TFLOPS)</option>
                                <option value="380">Trainium 2 (380 TFLOPS)</option>
                            </optgroup>
                        </select>
                        <div class="label-sub">Q (Assumes ~50% MFU of bf16 peak)</div>
                    </div>
                </div>

                <div class="hardware-box">
                    <div class="input-group-grid">
                        <!-- Intra DC -->
                        <div>
                            <div class="label-sm" style="color: var(--slate-700); font-weight: 700; margin-bottom: 0.5rem;">Intra-Datacenter</div>
                            <div style="margin-bottom: 0.5rem;">
                                <label class="label-sm">Bandwidth (Per Chip)</label>
                                <div class="input-addon-group">
                                    <input type="text" id="intraBw" value="400" class="form-control formatted-input">
                                    <span class="input-addon">Gbps</span>
                                </div>
                            </div>
                            <div class="flex-between-center">
                                <label class="label-sm">Overlap Intra-DC?</label>
                                <input type="checkbox" id="intraOverlap" checked style="cursor: pointer;">
                            </div>
                            <input type="hidden" id="intraLat" value="100">
                        </div>

                        <!-- Inter DC -->
                        <div>
                            <div class="label-sm" style="color: var(--slate-700); font-weight: 700; margin-bottom: 0.5rem;">Inter-Datacenter</div>
                            <div style="margin-bottom: 0.5rem;">
                                <label class="label-sm">Bandwidth (Per Chip)</label>
                                <div class="input-addon-group">
                                    <input type="text" id="interBw" value="100" class="form-control formatted-input">
                                    <span class="input-addon">Gbps</span>
                                </div>
                            </div>
                            <div>
                                <label class="label-sm">Latency</label>
                                <div class="input-addon-group">
                                    <input type="text" id="interLat" value="100" class="form-control formatted-input">
                                    <span class="input-addon">ms</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Results Section (Right Column) -->
        <div class="panel results-panel">
            <h2 class="result-title">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Estimated Wall-Clock Time
            </h2>
            
            <div>
                <div class="result-row">
                    <span class="result-key">Total Steps (T)</span>
                    <span class="result-val" id="resSteps">0</span>
                </div>

                <div class="bar-group">
                    <div class="bar-label">
                        <span>Computation Time</span>
                        <span class="result-val-sm" id="resComp">0h 0m</span>
                    </div>
                    <div class="bar-track">
                        <div id="barComp" class="bar-fill-blue" style="width: 0%"></div>
                    </div>
                </div>

                <div class="bar-group">
                    <div class="bar-label">
                        <span>Intra-DC Comm (Inner)</span>
                        <span class="result-val-sm" id="resCommIntra">0h 0m</span>
                    </div>
                    <div class="bar-track">
                        <div id="barIntra" class="bar-fill-indigo" style="width: 0%"></div>
                    </div>
                    <div id="intraBottleneckMsg" class="hidden text-right" style="font-size: 0.65rem; color: var(--red-500); margin-top: 0.25rem;">⚠️ Intra-DC bottleneck (Comm > Compute)</div>
                </div>

                <div class="bar-group">
                    <div class="bar-label">
                        <span>Inter-DC Comm (Outer)</span>
                        <span class="result-val-sm" id="resCommInter">0h 0m</span>
                    </div>
                    <div class="bar-track">
                        <div id="barInterGhost" class="bar-fill-purple-ghost" style="position: absolute; top:0; left:0; width: 0%"></div>
                        <div id="barInter" class="bar-fill-purple" style="position: absolute; top:0; left:0; width: 0%"></div>
                    </div>
                    <div id="overlapDetail" class="hidden overlap-detail">
                         <div style="color: var(--slate-500);">Overlap Check:</div>
                         <div>Background Comm: <span class="font-bold" id="valCommOuter"></span></div>
                         <div>Compute Window: <span class="font-bold" id="valCompWindow"></span> (x<span id="valStaleness">1</span>)</div>
                         <div id="overlapVerdict" class="font-bold mt-1"></div>
                    </div>
                </div>
            </div>

            <div class="total-row">
                <span class="label-sm" style="font-weight: 700; color: var(--blue-900); text-transform: uppercase;">Total Duration</span>
                <span class="total-val" id="resTotal">0h 0m</span>
            </div>

            <div class="flex-col" style="gap: 1rem;">
                <div class="metric-row">
                    <div>
                        <div class="label-sm">Predicted Eval Loss (Absolute):</div>
                        <div class="result-val-sm" style="display: flex; align-items: center;">
                            <span id="resLoss">0.000</span>
                            <span class="tag">Lower is better</span>
                        </div>
                    </div>
                </div>
                <div class="metric-row">
                     <div>
                        <div class="label-sm">Inter-DC Capacity (at each DC):</div>
                        <div class="result-val-sm" id="resInterCapacity">0 Gbps</div>
                    </div>
                </div>
                <div class="metric-row">
                     <div>
                        <div class="label-sm">Compute Utilization:</div>
                        <div class="result-val-sm" id="resUtil">0%</div>
                    </div>
                </div>
            </div>

            <!-- Formula Block (Inside Right Panel now) -->
            <div class="code-block">
                <div class="code-title">Underlying Math</div>
                <p id="mathMode" style="color: var(--green-400); font-weight: 700;">Standard DiLoCo (Sequential)</p>
                <p>T_comp = 6ND / (R × Q)</p>
                <p style="color: var(--slate-500);">// Intra-DC Communication (Inner Steps)</p>
                <p class="text-slate-300" id="mathIntra">T_intra = [ (2N / W₀) × (1 - M/R) + ε₀ ] × T</p>
                <p style="color: var(--slate-500);">// Inter-DC Communication (Outer Steps)</p>
                <p class="text-slate-300">T_comm_inter = [ (2N / W₁) × (1 - 1/R) + ε₁ ] × (T / H)</p>
                <div id="mathTotalFormula" style="border-top: 1px solid var(--slate-700); margin-top: 0.5rem; padding-top: 0.5rem;">
                    <p style="font-weight: 700;">Total = T_comp + T_comm_intra + T_comm_inter</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Figure 4 Plot -->
    <div class="plot-section">
        <h3 class="section-title" style="border:0; margin-bottom: 1rem;">Compute Utilization plot (Figure 4 of the Streaming DiLoCo paper)</h3>
        <div id="figure4Plot" class="plot-box">
            <!-- Chart injected here -->
        </div>
    </div>

    <!-- FAQ Section -->
    <div class="faq-section">
        <h2 class="section-title" style="border:0;">Frequently Asked Questions</h2>
        
        <div class="faq-item">
            <div class="faq-q">1. Source / Citation</div>
            <div class="faq-a">
                Based on <strong>Appendix A.2</strong> and <strong>A.3</strong> of <em>"Communication-Efficient Language Model Training Scales Reliably and Robustly"</em>.
                Model assumes <strong>bfloat16</strong> precision.
            </div>
        </div>

        <div class="faq-item">
            <div class="faq-q">2. Wouldn't a real-world implementation of Streaming Diloco need some form of Hierarchical All-Reduce?</div>
            <div class="faq-a">
                I think so, most likely. Real-world implementations typically use hierarchical collectives.
                However, the <strong>Scaling Laws paper</strong> explicitly models the time using the standard flat ring lower bound ($T \approx 2N/W$). This implies that if the Inter-DC link is the bottleneck, the total transfer time is governed by that bottleneck bandwidth ($W$) regardless of the reduction topology.
            </div>
        </div>

        <div class="faq-item">
            <div class="faq-q">3. What are Staleness (S) and Fragments (P)?</div>
            <div class="faq-a">
                <strong>Fragments (P):</strong> Streaming DiLoCo breaks the outer sync payload into $P$ chunks. While this doesn't change the <em>total</em> bytes sent, it allows for finer-grained overlap and lower memory overhead for buffers. <br>
                <strong>Staleness (S):</strong> By allowing the outer optimizer to be $S$ steps stale, the communication of gradients can be spread over $S$ intervals of length $H$. This effectively reduces the bandwidth requirement by a factor of $S$ (or allows using a link $S$ times slower without bottlenecking).
            </div>
        </div>

        <div class="faq-item">
            <div class="faq-q">4. Why is "Bandwidth (Per Chip)" used in the formulas?</div>
            <div class="faq-a">
                <p style="margin-bottom: 0.5rem;">
                    The training time calculation uses the bandwidth-optimal All-Reduce cost model from <em>Patarasuk & Yuan (2009)</em>, approximated in the paper as <code>T ≈ 2N / W</code>.
                    In this formula, <strong>W</strong> represents the per-chip link bandwidth.
                </p>
                <p>
                    However, the <strong>"Inter-DC Capacity"</strong> metric displayed in the results represents the <strong>aggregate cross-sectional bandwidth</strong> that would be required if every chip in the datacenter saturated its Inter-DC link simultaneously. It is calculated as <code>Bandwidth_Per_Chip × (R / M)</code>.
                </p>
            </div>
        </div>
        
        <div class="faq-item">
            <div class="faq-q">5. Why do Vanilla and Streaming DiLoCo lines overlap?</div>
            <div class="faq-a">
                In the simulator's model, Streaming DiLoCo sends the same <strong>total amount of data</strong> as Vanilla DiLoCo, just in smaller chunks. 
                The only difference is the added latency overhead of sending multiple fragments ($P \times \epsilon$). 
                For large models (e.g., 100B params), the bandwidth transfer time (tens of seconds) massively dominates the latency overhead (milliseconds), making the lines appear identical on the plot. 
                To see them diverge, try increasing the <strong>Fragments</strong> count or the <strong>Inter-DC Latency</strong>.
            </div>
        </div>
    </div>

<script>
    // Constants for Scaling Laws (Table 10)
    const SCALING_BATCH_A = 0.00709;
    const SCALING_BATCH_ALPHA = 0.4695;
    const SCALING_BATCH_BETA = 0.3399;
    const SEQ_LEN = 2048; 

    const SCALING_LOSS_A = 19.226;
    const SCALING_LOSS_ALPHA = -0.0985;
    const SCALING_LOSS_BETA = 0.0116;

    // Input Formatting Logic
    const formatNumber = (num) => {
        if (!num && num !== 0) return '';
        const cleanStr = num.toString().replace(/,/g, '');
        const val = parseFloat(cleanStr);
        if (isNaN(val)) return cleanStr;
        return val.toLocaleString('en-US');
    };

    const parseNumber = (str) => {
        if (!str) return 0;
        return parseFloat(str.replace(/,/g, '')) || 0;
    };

    function formatCapacity(bps) {
        const gbps = bps / 1e9;
        if (gbps < 1000) {
            return gbps.toFixed(1) + " Gbps";
        }
        const tbps = gbps / 1000;
        if (tbps < 1000) {
            return tbps.toFixed(2) + " Tbps";
        }
        const pbps = tbps / 1000;
        return pbps.toFixed(2) + " Pbps";
    }

    // Attach listeners
    document.querySelectorAll('.formatted-input').forEach(input => {
        input.value = formatNumber(input.value);
        input.addEventListener('focus', function() {
            this.value = this.value.replace(/,/g, '');
            this.select();
        });
        input.addEventListener('blur', function() {
            this.value = formatNumber(this.value);
        });
        input.addEventListener('input', calculate);
    });

    // Model Size Dropdown Logic
    const modelSizeSelect = document.getElementById('modelSizeSelect');
    const tokenBudgetInput = document.getElementById('tokenBudget');
    const batchSizeInput = document.getElementById('batchSize');

    modelSizeSelect.addEventListener('change', (e) => {
        const val = e.target.value;
        // Auto-update Token Budget (20 * N)
        const n = parseFloat(val);
        const d = n * 20;
        tokenBudgetInput.value = formatNumber(d);
        // Trigger calc
        calculate();
    });

    // Chip Dropdown Logic
    const chipSelect = document.getElementById('flopsPerChip');
    const intraBwInput = document.getElementById('intraBw');
    chipSelect.addEventListener('change', (e) => {
        // Simple heuristic map for better UX defaults
        const val = parseFloat(e.target.value);
        if (val >= 495) { // H100/B200
            intraBwInput.value = formatNumber(7200);
        } else if (val >= 138) { // A100/TPUs
            intraBwInput.value = formatNumber(3200);
        } else {
            intraBwInput.value = formatNumber(800);
        }
        calculate();
    });

    // Batch Suggestion Logic
    let suggestedBatchSize = 0;

    function updateBatchSuggestion(N, M) {
        const seqBatch = SCALING_BATCH_A * Math.pow(N, SCALING_BATCH_ALPHA) * Math.pow(M, SCALING_BATCH_BETA);
        suggestedBatchSize = Math.round(seqBatch * SEQ_LEN);
        
        document.getElementById('batchRecVal').innerText = formatNumber(suggestedBatchSize);
        document.getElementById('batchSuggestionVal').innerText = formatNumber(suggestedBatchSize);
        
        const currentBatch = parseNumber(batchSizeInput.value);
        if (Math.abs(currentBatch - suggestedBatchSize) > 1000) { 
             document.getElementById('batchSuggestion').style.display = 'block';
        } else {
             document.getElementById('batchSuggestion').style.display = 'none';
        }
    }

    window.applyBatchSuggestion = function() {
        if (suggestedBatchSize > 0) {
            batchSizeInput.value = formatNumber(suggestedBatchSize);
            calculate();
        }
    };

    const streamingToggle = document.getElementById('streamingToggle');
    const streamingOptions = document.getElementById('streamingOptions');
    
    streamingToggle.addEventListener('change', () => {
        if(streamingToggle.checked) {
            streamingOptions.classList.add('active');
        } else {
            streamingOptions.classList.remove('active');
        }
        calculate();
    });
    
    // Wire up new streaming/overlap inputs
    document.getElementById('staleness').addEventListener('input', calculate);
    document.getElementById('fragments').addEventListener('input', calculate);
    document.getElementById('intraOverlap').addEventListener('change', calculate);
    document.getElementById('intraBw').addEventListener('input', calculate); // Ensure manual edits update

    function formatTime(seconds) {
        if (seconds < 0) return "0s";
        if (seconds < 60) return seconds.toFixed(1) + "s";
        const d = Math.floor(seconds / (3600 * 24));
        const h = Math.floor((seconds % (3600 * 24)) / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);

        if (d > 0) return `${d}d ${h}h ${m}m`;
        if (h > 0) return `${h}h ${m}m ${s}s`;
        return `${m}m ${s}s`;
    }

    function calculateCore(overrideInterBw) {
        // Fetch values
        const N = parseFloat(document.getElementById('modelSizeSelect').value);
        const D = parseNumber(document.getElementById('tokenBudget').value);
        const B = parseNumber(document.getElementById('batchSize').value);
        const M = parseNumber(document.getElementById('replicas').value);
        const H = parseNumber(document.getElementById('syncCadence').value);
        const R = parseNumber(document.getElementById('totalChips').value);
        const Q_tera = parseFloat(document.getElementById('flopsPerChip').value);
        
        const W0_gbps = parseNumber(document.getElementById('intraBw').value);
        const e0_us = parseNumber(document.getElementById('intraLat').value);
        
        // Override W1 if running sweep
        const W1_gbps = overrideInterBw !== undefined ? overrideInterBw : parseNumber(document.getElementById('interBw').value);
        const e1_ms = parseNumber(document.getElementById('interLat').value);

        const isStreaming = document.getElementById('streamingToggle').checked;
        const staleness = isStreaming ? (parseNumber(document.getElementById('staleness').value) || 1) : 1;
        // P from UI used for Streaming (Sequential) overhead
        const fragments = isStreaming ? (parseNumber(document.getElementById('fragments').value) || 16) : 16; 
        const overlapIntra = document.getElementById('intraOverlap').checked;

        if (M < 2) return { error: "M must be >= 2" };

        const Q = Q_tera * 1e12; 
        const W0 = W0_gbps * 1e9; 
        const W1 = W1_gbps * 1e9; 
        const e0 = e0_us * 1e-6; 
        const e1 = e1_ms * 1e-3; 
        const PayloadBits = N * 16; 

        // Time calculations
        const T = D / B;
        const C = 6 * N * D;
        const T_comp = C / (R * Q);

        const inner_comm_per_step = ( (2 * PayloadBits) / W0 ) * (1 - M/R) + e0;
        const T_comm_intra = inner_comm_per_step * T;

        const outer_comm_per_step = ( (2 * PayloadBits) / W1 ) * (1 - 1/R) + e1;
        const T_comm_inter = outer_comm_per_step * (T / H);

        let T_total;
        let overlapState = "sequential"; 
        
        // Determine baseline (Compute Phase) with optional Intra-Overlap
        let T_baseline;
        if (overlapIntra) {
            // Assume we can hide comms behind compute, unless comms is slower
            // Total baseline time = max(T_comp, T_comm_intra)
            T_baseline = Math.max(T_comp, T_comm_intra);
        } else {
            T_baseline = T_comp + T_comm_intra;
        }

        if (isStreaming) {
            // Overlapping logic: T_baseline vs T_outer / Staleness
            const T_outer_effective = T_comm_inter / staleness;

            if (T_outer_effective <= T_baseline) {
                T_total = T_baseline;
                overlapState = "hidden";
            } else {
                T_total = T_outer_effective;
                overlapState = "bound";
            }
        } else {
            // Sequential DiLoCo adds Inter-DC on top
            T_total = T_baseline + T_comm_inter;
        }

        const utilization = (T_comp / T_total) * 100;

        return {
            T, T_comp, T_comm_intra, T_comm_inter, T_total, utilization, overlapState, staleness, fragments,
            N, M, R, W1_gbps, overlapIntra, T_baseline
        };
    }

    function calculate() {
        const res = calculateCore();
        if(res.error) {
            document.getElementById('resTotal').innerText = res.error;
            return;
        }

        const { N, M, R, W1_gbps } = res;

        // Suggestions
        if (N > 0 && M > 0) updateBatchSuggestion(N, M);

        // Loss
        if (N > 0 && M > 0) {
            const loss = SCALING_LOSS_A * Math.pow(N, SCALING_LOSS_ALPHA) * Math.pow(M, SCALING_LOSS_BETA);
            document.getElementById('resLoss').innerText = loss.toFixed(3);
        }

        // Capacity
        if (R > 0 && M > 0 && W1_gbps > 0) {
            const capacity = W1_gbps * 1e9 * (R / M); 
            document.getElementById('resInterCapacity').innerText = formatCapacity(capacity);
        } else {
            document.getElementById('resInterCapacity').innerText = "0 Gbps";
        }

        // Update UI Text
        document.getElementById('resSteps').innerText = Math.round(res.T).toLocaleString();
        document.getElementById('resComp').innerText = formatTime(res.T_comp);
        document.getElementById('resCommIntra').innerText = formatTime(res.T_comm_intra);
        document.getElementById('resCommInter').innerText = formatTime(res.T_comm_inter); 
        document.getElementById('resTotal').innerText = formatTime(res.T_total);
        document.getElementById('resUtil').innerText = res.utilization.toFixed(2) + "%";

        // Visuals - Intra Bottleneck
        const intraMsg = document.getElementById('intraBottleneckMsg');
        const commIntraElem = document.getElementById('resCommIntra');
        
        if (res.overlapIntra) {
            if (res.T_comm_intra > res.T_comp) {
                intraMsg.classList.remove('hidden');
                intraMsg.innerText = "⚠️ Intra-DC bottleneck (Comm > Compute)";
                commIntraElem.classList.remove('line-through');
                commIntraElem.classList.remove('text-slate-400');
            } else {
                intraMsg.classList.remove('hidden');
                intraMsg.innerText = "✅ Intra-DC Hidden";
                intraMsg.className = "text-right";
                intraMsg.style.color = "var(--green-500)";
                intraMsg.style.fontSize = "0.65rem";
                commIntraElem.classList.add('line-through');
                commIntraElem.classList.add('text-slate-400');
            }
        } else {
            intraMsg.classList.add('hidden');
            commIntraElem.classList.remove('line-through');
            commIntraElem.classList.remove('text-slate-400');
        }

        // Visuals - Inter Overlap
        const isStreaming = document.getElementById('streamingToggle').checked;
        const overlapDetail = document.getElementById('overlapDetail');
        const commInterElem = document.getElementById('resCommInter');
        
        if (isStreaming) {
            const T_outer = res.T_comm_inter / res.staleness;

            overlapDetail.classList.remove('hidden');
            document.getElementById('valCommOuter').innerText = formatTime(T_outer);
            document.getElementById('valCompWindow').innerText = formatTime(res.T_baseline);
            document.getElementById('overlapVerdict').innerText = res.overlapState === "hidden" 
                ? "✅ Fully Hidden (Comm < Window)" 
                : "⚠️ Network Bound (Comm > Window)";
            
            document.getElementById('overlapVerdict').style.color = res.overlapState === "hidden" 
                ? "var(--green-600)" 
                : "var(--orange-600)";

            if (res.overlapState === "hidden") {
                commInterElem.classList.add('line-through');
                commInterElem.classList.add('text-slate-400');
                document.getElementById('barInter').style.width = "0%";
                document.getElementById('barInterGhost').style.width = (T_outer / res.T_total * 100) + "%"; 
            } else {
                commInterElem.classList.remove('line-through');
                commInterElem.classList.remove('text-slate-400');
                document.getElementById('barInter').style.width = "100%"; 
                document.getElementById('barInterGhost').style.width = "0%";
            }
        } else {
            overlapDetail.classList.add('hidden');
            commInterElem.classList.remove('line-through');
            commInterElem.classList.remove('text-slate-400');
            document.getElementById('barInter').style.width = (res.T_comm_inter / res.T_total * 100) + "%";
            document.getElementById('barInterGhost').style.width = "0%";
        }

        // Bar logic
        if (res.overlapIntra && res.T_comm_intra <= res.T_comp) {
             document.getElementById('barComp').style.width = (res.T_comp / res.T_total * 100) + "%";
             document.getElementById('barIntra').style.width = "0%"; // Hidden
        } else if (res.overlapIntra && res.T_comm_intra > res.T_comp) {
             document.getElementById('barComp').style.width = "0%"; // Hidden by comms
             document.getElementById('barIntra').style.width = (res.T_comm_intra / res.T_total * 100) + "%";
        } else {
             document.getElementById('barComp').style.width = (res.T_comp / res.T_total * 100) + "%";
             document.getElementById('barIntra').style.width = (res.T_comm_intra / res.T_total * 100) + "%";
        }

        // Update Math Text
        const mathTitle = document.getElementById('mathMode');
        const mathFormula = document.getElementById('mathTotalFormula');
        const mathIntra = document.getElementById('mathIntra');
        
        if (res.overlapIntra) {
            mathIntra.innerText = "T_intra_eff = MAX(T_comp, T_intra_raw)";
        } else {
            mathIntra.innerText = "T_intra_eff = T_comp + T_intra_raw";
        }

        if (isStreaming) {
            mathTitle.innerText = "Streaming DiLoCo (Overlapped)";
            mathTitle.style.color = "var(--green-400)";
            mathFormula.innerHTML = `<p style="font-weight: 700;">Total = MAX( T_intra_eff, T_inter / S )</p>`;
        } else {
            mathTitle.innerText = "Standard DiLoCo (Sequential)";
            mathTitle.style.color = "var(--blue-400)";
            mathFormula.innerHTML = `<p style="font-weight: 700;">Total = T_intra_eff + T_inter</p>`;
        }

        // Update Sweep Plot
        updatePlot();
    }

    function updatePlot() {
        const container = document.getElementById('figure4Plot');
        if(!container) return;

        // Use direct container dimensions from DOM
        const width = container.clientWidth || 600;
        const height = 400; // Hardcoded fixed height to prevent vertical compression
        const padding = { top: 20, right: 20, bottom: 40, left: 50 }; 
        
        // Get base config (except Inter-DC BW which we sweep)
        const N = parseFloat(document.getElementById('modelSizeSelect').value);
        const B = parseNumber(document.getElementById('batchSize').value);
        const H = parseNumber(document.getElementById('syncCadence').value);
        const R = parseNumber(document.getElementById('totalChips').value);
        const M = parseNumber(document.getElementById('replicas').value); 
        const Q_tera = parseFloat(document.getElementById('flopsPerChip').value);
        const W0_gbps = parseNumber(document.getElementById('intraBw').value);
        const e0_us = parseNumber(document.getElementById('intraLat').value);
        const e1_ms = parseNumber(document.getElementById('interLat').value);
        const overlapIntra = document.getElementById('intraOverlap').checked;
        const staleness = parseNumber(document.getElementById('staleness').value) || 1;
        // P from UI used for Streaming (Sequential) overhead
        const fragments = parseNumber(document.getElementById('fragments').value) || 16; 

        // Constants
        const Q = Q_tera * 1e12;
        const W0 = W0_gbps * 1e9;
        const e0 = e0_us * 1e-6;
        const e1 = e1_ms * 1e-3;
        const PayloadBits = N * 16;
        const PayloadBitsFP4 = N * 4;
        
        // Per-Step calculations
        const C_step = 6 * N * B; // Flops per step
        const T_comp_step = C_step / (R * Q);
        const inner_comm_per_step = ((2 * PayloadBits) / W0) * (1 - M/R) + e0;
        const T_intra_step = inner_comm_per_step;
        
        // Baseline time per step (Compute + Intra)
        const T_baseline_step = overlapIntra ? Math.max(T_comp_step, T_intra_step) : (T_comp_step + T_intra_step);
        
        // Time for H steps (Inner Loop)
        const T_inner_phase = T_baseline_step * H; 

        // Sweep Configuration: 0.1G to 1000G
        const bwPoints = [];
        for (let exp = -1; exp <= 3; exp += 0.1) {
            bwPoints.push(Math.pow(10, exp));
        }

        // Series Definitions
        const seriesConfig = [
            { name: "Data Parallel", color: "#94a3b8" }, // Grey
            { name: "Vanilla DiLoCo", color: "#ef4444" }, // Red
            { name: "Streaming DiLoCo", color: "#f97316" }, // Orange
            { name: "Streaming + Overlap", color: "#3b82f6" }, // Blue
            { name: "Streaming + Overlap + FP4", color: "#10b981" } // Green
        ];

        const seriesData = seriesConfig.map(() => []);

        bwPoints.forEach(bw => {
            const W1 = bw * 1e9;
            const getInterTime = (bits) => ((2 * bits) / W1) * (1 - 1/R) + e1;
            
            // Comm Sync Times
            const comm_inter_sync = getInterTime(PayloadBits);
            const comm_inter_sync_fp4 = getInterTime(PayloadBitsFP4);

            // Overhead for Fragments (applied to ALL streaming variants)
            const T_frag_overhead = (fragments - 1) * e1;

            // 1. Data Parallel
            const T_dp_step = T_baseline_step + comm_inter_sync; 
            const util_dp = (T_comp_step / T_dp_step) * 100;

            // 2. Vanilla DiLoCo
            const T_vanilla_cycle = T_inner_phase + comm_inter_sync;
            const util_vanilla = ((T_comp_step * H) / T_vanilla_cycle) * 100;

            // 3. Streaming (Sequential)
            // Difference: Pay latency cost P times. 
            const T_streaming_cycle = T_vanilla_cycle + T_frag_overhead;
            const util_streaming = ((T_comp_step * H) / T_streaming_cycle) * 100;

            // 4. Streaming + Overlap
            // T_total_cycle = Max(T_inner_phase, (T_inter_sync + overhead) / S)
            // Note: Staleness S allows spreading the *entire* cost (transfer + overhead)
            const T_overlap_cycle = Math.max(T_inner_phase, (comm_inter_sync + T_frag_overhead) / staleness);
            const util_overlap = ((T_comp_step * H) / T_overlap_cycle) * 100;

            // 5. Streaming + Overlap + FP4
            const T_overlap_fp4_cycle = Math.max(T_inner_phase, (comm_inter_sync_fp4 + T_frag_overhead) / staleness);
            const util_overlap_fp4 = ((T_comp_step * H) / T_overlap_fp4_cycle) * 100;

            seriesData[0].push({ x: bw, y: util_dp });
            seriesData[1].push({ x: bw, y: util_vanilla });
            seriesData[2].push({ x: bw, y: util_streaming });
            seriesData[3].push({ x: bw, y: util_overlap });
            seriesData[4].push({ x: bw, y: util_overlap_fp4 });
        });

        // SVG Drawing
        let svg = `<svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg" style="font-family: sans-serif; font-size: 0.75rem;">`;
        svg += `<rect width="100%" height="100%" fill="white" />`;

        const minX = Math.log(0.1);
        const maxX = Math.log(1000);
        const scaleX = (val) => padding.left + ((Math.log(val) - minX) / (maxX - minX)) * (width - padding.left - padding.right);
        const scaleY = (val) => height - padding.bottom - (val / 100) * (height - padding.top - padding.bottom);

        // Grid & Y Axis
        for (let i = 0; i <= 100; i += 20) {
            const y = scaleY(i);
            svg += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#e2e8f0" />`;
            svg += `<text x="${padding.left - 5}" y="${y + 3}" text-anchor="end" fill="#64748b">${i}%</text>`;
        }
        
        // X Axis & Grid (Logarithmic)
        const majorTicks = [0.1, 1, 10, 100, 1000];
        const labels = ["10⁻¹", "10⁰", "10¹", "10²", "10³"];
        
        // Minor grid lines
        for (let i = -1; i < 3; i++) {
            const base = Math.pow(10, i);
            for (let j = 2; j < 10; j++) {
                const val = base * j;
                const x = scaleX(val);
                svg += `<line x1="${x}" y1="${height - padding.bottom}" x2="${x}" y2="${padding.top}" stroke="#f1f5f9" />`;
            }
        }

        majorTicks.forEach((val, i) => {
            const x = scaleX(val);
            svg += `<line x1="${x}" y1="${height - padding.bottom}" x2="${x}" y2="${padding.top}" stroke="#cbd5e1" stroke-dasharray="4" />`;
            svg += `<text x="${x}" y="${height - padding.bottom + 15}" text-anchor="middle" fill="#64748b">${labels[i]}</text>`;
        });

        svg += `<text x="${width/2}" y="${height-5}" text-anchor="middle" fill="#475569" font-weight="bold">Inter-DC Bandwidth (Gbps)</text>`;
        svg += `<text x="${15}" y="${height/2}" text-anchor="middle" fill="#475569" font-weight="bold" transform="rotate(-90, 15, ${height/2})">Compute Utilization</text>`;

        // Paths
        seriesData.forEach((points, i) => {
            const pathD = points.map((p, idx) => `${idx === 0 ? 'M' : 'L'} ${scaleX(p.x)} ${scaleY(p.y)}`).join(' ');
            const dash = i === 2 ? 'stroke-dasharray="4,2"' : ''; 
            svg += `<path d="${pathD}" fill="none" stroke="${seriesConfig[i].color}" stroke-width="2" ${dash} />`;
        });

        // Legend (Top Left)
        const legendX = padding.left + 15;
        const legendY = padding.top + 10;
        
        // Legend Background
        svg += `<rect x="${legendX - 5}" y="${legendY - 5}" width="180" height="${seriesConfig.length * 15 + 10}" fill="rgba(255,255,255,0.9)" stroke="#e2e8f0" rx="4" />`;

        seriesData.forEach((points, i) => {
            const legY = legendY + i * 15;
            const dash = i === 2 ? 'stroke-dasharray="4,2"' : ''; 
            svg += `<line x1="${legendX}" y1="${legY+5}" x2="${legendX+15}" y2="${legY+5}" stroke="${seriesConfig[i].color}" stroke-width="2" ${dash} />`;
            svg += `<text x="${legendX + 20}" y="${legY + 9}" fill="#475569" style="font-size: 10px; font-weight: 500;">${seriesConfig[i].name}</text>`;
        });

        svg += `</svg>`;
        container.innerHTML = svg;
    }

    // Initial calculation
    calculate();
</script>

</body>
</html>