<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiLoCo Bandwidth Simulator</title>
    <style>
        :root {
            /* Color Palette */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;

            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-200: #bfdbfe;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;
            --blue-900: #1e3a8a;

            --green-50: #f0fdf4;
            --green-100: #dcfce7;
            --green-200: #bbf7d0;
            --green-400: #4ade80;
            --green-600: #16a34a;
            --green-800: #166534;

            --indigo-500: #6366f1;
            --purple-200: #e9d5ff;
            --purple-500: #a855f7;
            --purple-600: #9333ea;
            --red-500: #ef4444;
            --orange-600: #ea580c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--slate-800);
            line-height: 1.5;
            margin: 0;
            padding: 2rem;
        }

        /* Layout */
        .container {
            max-width: 64rem;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--slate-200);
            padding-bottom: 1rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--blue-600);
            margin: 0;
        }

        .header p {
            font-size: 0.875rem;
            color: var(--slate-500);
            margin-top: 0.5rem;
        }
        
        .header a {
            color: var(--blue-500);
            text-decoration: none;
        }
        .header a:hover {
            text-decoration: underline;
        }

        .grid-2-cols {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 1024px) {
            .grid-2-cols {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Panels */
        .panel {
            background-color: var(--bg-card);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--slate-100);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .results-panel {
            background-color: var(--blue-50);
            border: 1px solid var(--blue-100);
        }

        /* Typography */
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--slate-700);
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--slate-100);
            padding-bottom: 0.5rem;
        }
        
        .result-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--blue-900);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .label-sm {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--slate-500);
            margin-bottom: 0.25rem;
        }

        .label-sub {
            font-size: 0.65rem;
            color: var(--slate-400);
            margin-top: 0.25rem;
        }

        /* Forms */
        .input-group-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--slate-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: var(--slate-50);
            color: var(--slate-700);
            font-weight: 500;
            box-sizing: border-box;
            outline: none;
        }

        .form-control:focus {
            outline: 2px solid var(--blue-600);
            outline-offset: 1px;
            border-color: var(--blue-600);
        }

        .input-addon-group {
            display: flex;
            align-items: center;
        }
        
        .input-addon-group input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .input-addon {
            background-color: var(--slate-100);
            border: 1px solid var(--slate-300);
            border-left: 0;
            color: var(--slate-500);
            font-size: 0.65rem;
            padding: 0.5rem 0.75rem;
            border-top-right-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            display: flex;
            align-items: center;
            height: 100%;
            box-sizing: border-box;
            line-height: 1.25rem; /* Match input line-height approx */
        }
        
        /* Fix for input height matching */
        .form-control { height: 2.5rem; } 

        .flex-between-center {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Toggle Switch */
        .toggle-container {
            margin-top: 1rem;
            background-color: var(--green-50);
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--green-100);
        }
        
        .toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .toggle-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--green-800);
        }

        .toggle-desc {
            font-size: 0.65rem;
            color: var(--green-600);
            margin-top: 0.125rem;
        }

        .toggle-wrapper {
            position: relative;
            display: inline-block;
            width: 2.5rem;
            height: 1.25rem;
        }

        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .2s;
            border-radius: 9999px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.25rem;
            width: 1.25rem;
            left: 0;
            bottom: 0;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .toggle-checkbox:checked + .toggle-slider {
            background-color: var(--green-400);
        }

        .toggle-checkbox:checked + .toggle-slider:before {
            transform: translateX(100%);
            border-color: var(--green-400);
        }
        
        .streaming-options {
            display: none; /* Hidden by default via JS */
            border-top: 1px solid var(--green-200); 
            padding-top: 0.75rem; 
            margin-top: 0.5rem;
        }
        
        .streaming-options.active {
            display: grid;
        }

        /* Results & Bars */
        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--blue-200);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .result-key {
            font-size: 0.875rem;
            color: var(--blue-900);
        }

        .result-val {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--blue-900);
        }

        .result-val-sm {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--slate-800);
        }

        .bar-group {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }

        .bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: var(--slate-600);
            margin-bottom: 0.25rem;
        }

        .bar-track {
            width: 100%;
            height: 0.375rem;
            background-color: var(--blue-200);
            border-radius: 9999px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill-blue { background-color: var(--blue-600); height: 100%; transition: width 0.3s; }
        .bar-fill-indigo { background-color: var(--indigo-500); height: 100%; transition: width 0.3s; }
        .bar-fill-purple { background-color: var(--purple-500); height: 100%; transition: width 0.3s; }
        .bar-fill-purple-ghost { background-color: var(--purple-200); height: 100%; transition: width 0.3s; }

        .total-row {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--blue-200);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .total-val {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 1.875rem;
            color: var(--blue-700);
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            border-top: 1px solid var(--blue-200);
            padding-top: 0.75rem;
        }

        .tag {
            font-size: 0.65rem;
            font-weight: 400;
            color: var(--slate-400);
            background-color: var(--slate-100);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }

        .line-through { text-decoration: line-through; color: var(--slate-400) !important; }
        .hidden { display: none !important; }

        /* Code Block */
        .code-block {
            background-color: var(--slate-900);
            color: var(--slate-300);
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.75rem;
            overflow-x: auto;
            margin-top: 1.5rem;
        }
        
        .code-title {
            color: var(--slate-100);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            font-size: 0.65rem;
        }

        /* Plot Container */
        .plot-section {
            margin-bottom: 3rem;
            width: 100%;
        }

        .plot-box {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 0.5rem;
            overflow: hidden;
            width: 100%;
            height: 400px;
            box-sizing: border-box;
            padding: 1rem;
        }

        /* Utilities */
        .text-green-400 { color: var(--green-400); }
        .text-blue-400 { color: var(--blue-400); }
        .text-slate-300 { color: var(--slate-300); }
        .text-green-600 { color: var(--green-600); }
        .text-orange-600 { color: var(--orange-600); }
        .text-red-500 { color: var(--red-500); }
        .text-green-500 { color: #22c55e; }
        .font-bold { font-weight: 700; }
        .text-right { text-align: right; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }

        .overlap-detail {
            font-family: monospace;
            font-size: 0.65rem;
            text-align: right;
            background: rgba(255,255,255,0.5);
            padding: 0.25rem;
            border: 1px solid var(--blue-100);
            border-radius: 0.25rem;
            margin-top: 0.25rem;
        }

        /* FAQ */
        .faq-section {
            margin-top: 3rem;
            border-top: 1px solid var(--slate-200);
            padding-top: 2rem;
        }
        .faq-item { margin-bottom: 1.5rem; }
        .faq-q { font-weight: 600; font-size: 0.875rem; color: var(--slate-800); }
        .faq-a { font-size: 0.875rem; color: var(--slate-600); margin-top: 0.25rem; }

        /* Hardware section specific */
        .hardware-box {
            background-color: var(--slate-50);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--slate-200);
        }

        /* Tooltip */
        .tooltip-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .tooltip-bubble {
            visibility: hidden;
            opacity: 0;
            background-color: var(--slate-800);
            color: white;
            text-align: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.75rem;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .tooltip-bubble::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--slate-800) transparent transparent transparent;
        }

        .tooltip-wrapper:hover .tooltip-bubble {
            visibility: visible;
            opacity: 1;
        }

        .form-control:disabled {
            background-color: var(--slate-200);
            color: var(--slate-400);
            cursor: not-allowed;
        }

        /* Save Configuration Button */
        .save-config-btn {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--blue-600);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .save-config-btn:hover {
            background-color: var(--blue-700);
        }

        .save-config-btn:active {
            transform: scale(0.98);
        }

        /* Configuration Cards */
        .config-card {
            background-color: white;
            border: 2px solid var(--blue-200);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.2s;
        }

        .config-card:hover {
            border-color: var(--blue-400);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .config-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--blue-900);
            margin-bottom: 0.25rem;
        }

        .config-util {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--blue-600);
            font-family: 'SF Mono', 'Roboto Mono', monospace;
        }

        .config-params {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--slate-600);
        }

        .config-param {
            display: flex;
            justify-content: space-between;
        }

        .config-param-label {
            color: var(--slate-500);
        }

        .config-param-value {
            font-weight: 600;
            color: var(--slate-700);
            font-family: 'SF Mono', 'Roboto Mono', monospace;
        }

        .delete-config-btn {
            background-color: var(--red-500);
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .delete-config-btn:hover {
            background-color: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--slate-400);
        }

        .empty-state svg {
            margin: 0 auto 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body class="container">

    <header class="header">
        <h1>DiLoCo Bandwidth Simulator</h1>
        <p>
            Vibecoded (<a href="https://github.com/mino98/diloco-calculator" target="_blank">repo</a>) based on the paper trilogy: 
            <a href="https://arxiv.org/abs/2311.08105" target="_blank">DiLoCo</a>, 
            <a href="https://arxiv.org/abs/2501.18512" target="_blank">Streaming DiLoCo</a>, 
            <a href="https://arxiv.org/abs/2503.09799" target="_blank">Scaling Laws</a>
        </p>
    </header>

    <!-- Top Configuration Panel -->
    <div class="panel" style="margin-bottom: 2rem;">
        <h2 class="section-title">Model & Network Configuration</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
                <label class="label-sm">Model Size</label>
                <select id="modelSizeSelect" class="form-control">
                    <option value="1000000000">1B Params</option>
                    <option value="10000000000" selected>10B Params</option>
                    <option value="100000000000">100B Params</option>
                    <option value="1000000000000">1T Params</option>
                </select>
                <div class="label-sub">N (number of parameters)</div>
            </div>

            <div>
                <label class="label-sm">Compute Time per Step</label>
                <input type="text" id="secondsPerStep" value="1.0" class="form-control formatted-input">
                <div class="label-sub">Seconds</div>
            </div>

            <div>
                <label class="label-sm">Number of Datacenters</label>
                <input type="text" id="numDatacenters" value="2" class="form-control formatted-input">
                <div class="label-sub">M (≥1)</div>
            </div>

            <div>
                <label class="label-sm">Bandwidth Between DCs</label>
                <div class="input-addon-group">
                    <input type="text" id="interBw" value="100" class="form-control formatted-input">
                    <span class="input-addon">Gbps</span>
                </div>
                <div class="label-sub">B (inter-DC bandwidth)</div>
            </div>
        </div>
    </div>

    <!-- Hardcoded Configurations -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 2rem;">

        <!-- Configuration 1: Data Parallel -->
        <div class="panel">
            <h2 class="section-title" style="color: #94a3b8; border-color: #94a3b8;">Data Parallel (H=1)</h2>

            <div class="grid-2-cols">
                <div>
                    <div class="mb-4">
                        <label class="label-sm">Gradients Data Type</label>
                        <select id="dp_dtype" class="form-control">
                            <option value="2" selected>bfloat16 (2 bytes)</option>
                            <option value="1">int8 (1 byte)</option>
                            <option value="0.5">int4 (0.5 bytes)</option>
                        </select>
                    </div>
                </div>

                <div class="results-panel" style="padding: 1rem; border-radius: 0.5rem;">
                    <div class="result-row">
                        <span class="result-key">Compute Utilization</span>
                        <span class="result-val" id="dp_util">-</span>
                    </div>
                    <div class="result-row" style="border: 0;">
                        <span class="result-key">Total Time</span>
                        <span class="result-val-sm" id="dp_time">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration 2: DiLoCo -->
        <div class="panel">
            <h2 class="section-title" style="color: #ef4444; border-color: #ef4444;">DiLoCo</h2>

            <div class="grid-2-cols">
                <div>
                    <div class="mb-4">
                        <label class="label-sm">Gradients Data Type</label>
                        <select id="diloco_dtype" class="form-control">
                            <option value="2" selected>bfloat16 (2 bytes)</option>
                            <option value="1">int8 (1 byte)</option>
                            <option value="0.5">int4 (0.5 bytes)</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="label-sm">Synchronization Cadence (H)</label>
                        <input type="text" id="diloco_H" value="30" class="form-control formatted-input">
                    </div>
                </div>

                <div class="results-panel" style="padding: 1rem; border-radius: 0.5rem;">
                    <div class="result-row">
                        <span class="result-key">Compute Utilization</span>
                        <span class="result-val" id="diloco_util">-</span>
                    </div>
                    <div class="result-row" style="border: 0;">
                        <span class="result-key">Total Time</span>
                        <span class="result-val-sm" id="diloco_time">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration 3: Streaming DiLoCo with Overlap -->
        <div class="panel">
            <h2 class="section-title" style="color: #3b82f6; border-color: #3b82f6;">Streaming DiLoCo with Overlap</h2>

            <div class="grid-2-cols">
                <div>
                    <div class="mb-4">
                        <label class="label-sm">Gradients Data Type</label>
                        <select id="streaming_dtype" class="form-control">
                            <option value="2" selected>bfloat16 (2 bytes)</option>
                            <option value="1">int8 (1 byte)</option>
                            <option value="0.5">int4 (0.5 bytes)</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="label-sm">Synchronization Cadence (H)</label>
                        <input type="text" id="streaming_H" value="30" class="form-control formatted-input">
                    </div>

                    <div class="mb-4">
                        <label class="label-sm">Number of Fragments (P)</label>
                        <input type="text" id="streaming_P" value="5" class="form-control formatted-input">
                    </div>

                    <div class="mb-4">
                        <label class="label-sm">Number of Overlap (S)</label>
                        <input type="text" id="streaming_S" value="10" class="form-control formatted-input">
                    </div>
                </div>

                <div class="results-panel" style="padding: 1rem; border-radius: 0.5rem;">
                    <div class="result-row">
                        <span class="result-key">Compute Utilization</span>
                        <span class="result-val" id="streaming_util">-</span>
                    </div>
                    <div class="result-row" style="border: 0;">
                        <span class="result-key">Total Time</span>
                        <span class="result-val-sm" id="streaming_time">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Figure 4 Plot -->
    <div class="plot-section">
        <h3 class="section-title" style="border:0; margin-bottom: 1rem;">Compute Utilization plot (Figure 4 of the Streaming DiLoCo paper)</h3>
        <div id="figure4Plot" class="plot-box">
            <!-- Chart injected here -->
        </div>
    </div>

    <!-- Footer -->
    <footer style="margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--slate-200); text-align: center; color: var(--slate-500); font-size: 0.875rem;">
        <p>
            Originally forked from <a href="https://mino98.github.io/diloco-calculator/" target="_blank" style="color: var(--blue-500); text-decoration: none;">mino98's DiLoCo Calculator</a>
        </p>
    </footer>

    <!-- Hidden fields for fixed parameters -->
    <input type="hidden" id="totalSteps" value="1000">
    <input type="hidden" id="totalChips" value="100">

<script>
    // Constants for Scaling Laws (Table 10)
    const SCALING_BATCH_A = 0.00709;
    const SCALING_BATCH_ALPHA = 0.4695;
    const SCALING_BATCH_BETA = 0.3399;
    const SEQ_LEN = 2048; 

    const SCALING_LOSS_A = 19.226;
    const SCALING_LOSS_ALPHA = -0.0985;
    const SCALING_LOSS_BETA = 0.0116;

    // Input Formatting Logic
    const formatNumber = (num) => {
        if (!num && num !== 0) return '';
        const cleanStr = num.toString().replace(/,/g, '');
        const val = parseFloat(cleanStr);
        if (isNaN(val)) return cleanStr;
        return val.toLocaleString('en-US');
    };

    const parseNumber = (str) => {
        if (!str) return 0;
        return parseFloat(str.replace(/,/g, '')) || 0;
    };

    function formatCapacity(bps) {
        const gbps = bps / 1e9;
        if (gbps < 1000) {
            return gbps.toFixed(1) + " Gbps";
        }
        const tbps = gbps / 1000;
        if (tbps < 1000) {
            return tbps.toFixed(2) + " Tbps";
        }
        const pbps = tbps / 1000;
        return pbps.toFixed(2) + " Pbps";
    }

    // Attach listeners
    document.querySelectorAll('.formatted-input').forEach(input => {
        input.value = formatNumber(input.value);
        input.addEventListener('focus', function() {
            this.value = this.value.replace(/,/g, '');
            this.select();
        });
        input.addEventListener('blur', function() {
            this.value = formatNumber(this.value);
        });
        input.addEventListener('input', updateConfigurations);
    });

    // Model Size Dropdown
    document.getElementById('modelSizeSelect').addEventListener('change', updateConfigurations);

    // Wire up all input listeners for global settings
    document.getElementById('numDatacenters').addEventListener('input', updateConfigurations);
    document.getElementById('secondsPerStep').addEventListener('input', updateConfigurations);
    document.getElementById('interBw').addEventListener('input', updateConfigurations);

    // Wire up listeners for configuration-specific inputs
    document.getElementById('dp_dtype').addEventListener('change', updateConfigurations);
    document.getElementById('diloco_dtype').addEventListener('change', updateConfigurations);
    document.getElementById('diloco_H').addEventListener('input', updateConfigurations);
    document.getElementById('streaming_dtype').addEventListener('change', updateConfigurations);
    document.getElementById('streaming_H').addEventListener('input', updateConfigurations);
    document.getElementById('streaming_P').addEventListener('input', updateConfigurations);
    document.getElementById('streaming_S').addEventListener('input', updateConfigurations);

    function formatTime(seconds) {
        if (seconds < 0) return "0s";
        if (seconds < 60) return seconds.toFixed(1) + "s";
        const d = Math.floor(seconds / (3600 * 24));
        const h = Math.floor((seconds % (3600 * 24)) / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);

        if (d > 0) return `${d}d ${h}h ${m}m`;
        if (h > 0) return `${h}h ${m}m ${s}s`;
        return `${m}m ${s}s`;
    }

    function calculateCore(H, bytesPerParam, S, P, overrideInterBw) {
        // Fetch global values
        const N = parseFloat(document.getElementById('modelSizeSelect').value);
        const T = parseNumber(document.getElementById('totalSteps').value);
        const secondsPerStep = parseNumber(document.getElementById('secondsPerStep').value);
        const M = parseNumber(document.getElementById('numDatacenters').value);

        // Override bandwidth if running sweep
        const B_gbps = overrideInterBw !== undefined ? overrideInterBw : parseNumber(document.getElementById('interBw').value);

        if (M < 1) return { error: "M must be >= 1" };
        if (H < 1) return { error: "H must be >= 1" };

        // Data size in bytes
        const D = N * bytesPerParam;

        // Convert bandwidth from Gbps to bytes/second: Gbps * 1e9 / 8
        const B_bytes_per_sec = B_gbps * 1e9 / 8;

        // Time calculations
        const T_comp = secondsPerStep * T;

        // Communication time per synchronization using new formula:
        // T_comm_per_sync = 2 * (1 - 1/M) * D / B
        let T_comm_per_sync = 0;
        if (M > 1) {
            T_comm_per_sync = 2 * (1 - 1/M) * D / B_bytes_per_sec;
        }

        // Total communication time across all syncs
        const num_syncs = T / H;
        const T_comm_inter = T_comm_per_sync * num_syncs;

        // Determine mode and calculate total time
        let T_total;
        let overlapState = "sequential";
        let mode = "Data-Parallel";

        if (H === 1) {
            // Data-Parallel mode
            T_total = T_comp + T_comm_inter;
            overlapState = "data_parallel";
            mode = "Data-Parallel";
        } else if (S > 0 || P > 1) {
            // Streaming DiLoCo mode
            mode = "Streaming DiLoCo";

            // With overlapping, communication can be hidden behind computation
            // We assume perfect overlap up to the computation window
            const effective_staleness = Math.max(S, 1);
            const T_outer_effective = T_comm_inter / effective_staleness;

            if (T_outer_effective <= T_comp) {
                T_total = T_comp;
                overlapState = "hidden";
            } else {
                T_total = T_outer_effective;
                overlapState = "bound";
            }
        } else {
            // Standard DiLoCo mode
            mode = "DiLoCo";
            T_total = T_comp + T_comm_inter;
        }

        const utilization = (T_comp / T_total) * 100;

        return {
            T, T_comp, T_comm_inter, T_total, utilization, overlapState,
            N, M, H, bytesPerParam, S, P, B_gbps, mode
        };
    }

    function updateConfigurations() {
        // Configuration 1: Data Parallel (H=1, S=0, P=1)
        const dp_dtype = parseFloat(document.getElementById('dp_dtype').value);
        const dp_result = calculateCore(1, dp_dtype, 0, 1);
        if (!dp_result.error) {
            document.getElementById('dp_util').textContent = dp_result.utilization.toFixed(1) + '%';
            document.getElementById('dp_time').textContent = formatTime(dp_result.T_total);
        }

        // Configuration 2: DiLoCo (H>1, S=0, P=1)
        const diloco_dtype = parseFloat(document.getElementById('diloco_dtype').value);
        const diloco_H = parseNumber(document.getElementById('diloco_H').value);
        const diloco_result = calculateCore(diloco_H, diloco_dtype, 0, 1);
        if (!diloco_result.error) {
            document.getElementById('diloco_util').textContent = diloco_result.utilization.toFixed(1) + '%';
            document.getElementById('diloco_time').textContent = formatTime(diloco_result.T_total);
        }

        // Configuration 3: Streaming DiLoCo with Overlap
        const streaming_dtype = parseFloat(document.getElementById('streaming_dtype').value);
        const streaming_H = parseNumber(document.getElementById('streaming_H').value);
        const streaming_P = parseNumber(document.getElementById('streaming_P').value);
        const streaming_S = parseNumber(document.getElementById('streaming_S').value);
        const streaming_result = calculateCore(streaming_H, streaming_dtype, streaming_S, streaming_P);
        if (!streaming_result.error) {
            document.getElementById('streaming_util').textContent = streaming_result.utilization.toFixed(1) + '%';
            document.getElementById('streaming_time').textContent = formatTime(streaming_result.T_total);
        }

        // Update the plot as well
        updatePlot();
    }


    function updatePlot() {
        const container = document.getElementById('figure4Plot');
        if(!container) return;

        // Use direct container dimensions from DOM
        const width = container.clientWidth || 600;
        const height = 400; // Hardcoded fixed height to prevent vertical compression
        const padding = { top: 20, right: 20, bottom: 40, left: 50 };

        // Get global config
        const N = parseFloat(document.getElementById('modelSizeSelect').value);
        const secondsPerStep = parseNumber(document.getElementById('secondsPerStep').value);
        const M = parseNumber(document.getElementById('numDatacenters').value);

        // Get configuration-specific settings
        const dp_dtype = parseFloat(document.getElementById('dp_dtype').value);
        const diloco_dtype = parseFloat(document.getElementById('diloco_dtype').value);
        const diloco_H = parseNumber(document.getElementById('diloco_H').value);
        const streaming_dtype = parseFloat(document.getElementById('streaming_dtype').value);
        const streaming_H = parseNumber(document.getElementById('streaming_H').value);
        const streaming_P = parseNumber(document.getElementById('streaming_P').value);
        const streaming_S = parseNumber(document.getElementById('streaming_S').value);

        // Per-Step calculations
        const T_comp_step = secondsPerStep; 

        // Sweep Configuration: 0.1G to 1000G
        const bwPoints = [];
        for (let exp = -1; exp <= 3; exp += 0.1) {
            bwPoints.push(Math.pow(10, exp));
        }

        // Series Definitions based on hardcoded configurations
        const seriesConfig = [
            { name: "Data Parallel", color: "#94a3b8" },
            { name: "DiLoCo", color: "#ef4444" },
            { name: "Streaming DiLoCo with Overlap", color: "#3b82f6" }
        ];

        const seriesData = seriesConfig.map(() => []);

        bwPoints.forEach(bw => {
            // Calculate for each configuration at this bandwidth
            const dp_res = calculateCore(1, dp_dtype, 0, 1, bw);
            const diloco_res = calculateCore(diloco_H, diloco_dtype, 0, 1, bw);
            const streaming_res = calculateCore(streaming_H, streaming_dtype, streaming_S, streaming_P, bw);

            seriesData[0].push({ x: bw, y: dp_res.utilization });
            seriesData[1].push({ x: bw, y: diloco_res.utilization });
            seriesData[2].push({ x: bw, y: streaming_res.utilization });
        });

        // SVG Drawing
        let svg = `<svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg" style="font-family: sans-serif; font-size: 0.75rem;">`;
        svg += `<rect width="100%" height="100%" fill="white" />`;

        const minX = Math.log(0.1);
        const maxX = Math.log(1000);
        const scaleX = (val) => padding.left + ((Math.log(val) - minX) / (maxX - minX)) * (width - padding.left - padding.right);
        const scaleY = (val) => height - padding.bottom - (val / 100) * (height - padding.top - padding.bottom);

        // Grid & Y Axis
        for (let i = 0; i <= 100; i += 20) {
            const y = scaleY(i);
            svg += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#e2e8f0" />`;
            svg += `<text x="${padding.left - 5}" y="${y + 3}" text-anchor="end" fill="#64748b">${i}%</text>`;
        }
        
        // X Axis & Grid (Logarithmic)
        const majorTicks = [0.1, 1, 10, 100, 1000];
        const labels = ["10⁻¹", "10⁰", "10¹", "10²", "10³"];
        
        // Minor grid lines
        for (let i = -1; i < 3; i++) {
            const base = Math.pow(10, i);
            for (let j = 2; j < 10; j++) {
                const val = base * j;
                const x = scaleX(val);
                svg += `<line x1="${x}" y1="${height - padding.bottom}" x2="${x}" y2="${padding.top}" stroke="#f1f5f9" />`;
            }
        }

        majorTicks.forEach((val, i) => {
            const x = scaleX(val);
            svg += `<line x1="${x}" y1="${height - padding.bottom}" x2="${x}" y2="${padding.top}" stroke="#cbd5e1" stroke-dasharray="4" />`;
            svg += `<text x="${x}" y="${height - padding.bottom + 15}" text-anchor="middle" fill="#64748b">${labels[i]}</text>`;
        });

        svg += `<text x="${width/2}" y="${height-5}" text-anchor="middle" fill="#475569" font-weight="bold">Inter-DC Bandwidth (Gbps)</text>`;
        svg += `<text x="${15}" y="${height/2}" text-anchor="middle" fill="#475569" font-weight="bold" transform="rotate(-90, 15, ${height/2})">Compute Utilization</text>`;

        // Paths
        seriesData.forEach((points, i) => {
            const pathD = points.map((p, idx) => `${idx === 0 ? 'M' : 'L'} ${scaleX(p.x)} ${scaleY(p.y)}`).join(' ');
            const dash = i === 2 ? 'stroke-dasharray="4,2"' : ''; 
            svg += `<path d="${pathD}" fill="none" stroke="${seriesConfig[i].color}" stroke-width="2" ${dash} />`;
        });

        // Legend (Top Left)
        const legendX = padding.left + 15;
        const legendY = padding.top + 10;
        
        // Legend Background
        svg += `<rect x="${legendX - 5}" y="${legendY - 5}" width="180" height="${seriesConfig.length * 15 + 10}" fill="rgba(255,255,255,0.9)" stroke="#e2e8f0" rx="4" />`;

        seriesData.forEach((points, i) => {
            const legY = legendY + i * 15;
            const dash = i === 2 ? 'stroke-dasharray="4,2"' : ''; 
            svg += `<line x1="${legendX}" y1="${legY+5}" x2="${legendX+15}" y2="${legY+5}" stroke="${seriesConfig[i].color}" stroke-width="2" ${dash} />`;
            svg += `<text x="${legendX + 20}" y="${legY + 9}" fill="#475569" style="font-size: 10px; font-weight: 500;">${seriesConfig[i].name}</text>`;
        });

        svg += `</svg>`;
        container.innerHTML = svg;
    }

    // Initial render
    updateConfigurations();
</script>

</body>
</html>