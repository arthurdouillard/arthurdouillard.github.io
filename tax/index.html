<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Calculator</title>
    <style>
        :root {
            /* Color Palette */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;

            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;

            --blue-50: #fff7ed;
            --blue-100: #ffedd5;
            --blue-200: #fed7aa;
            --blue-500: #f97316;
            --blue-600: #d95f0e;
            --blue-700: #c2410c;
            --blue-900: #7c2d12;

            --green-50: #f0fdf4;
            --green-100: #dcfce7;
            --green-200: #bbf7d0;
            --green-400: #4ade80;
            --green-600: #16a34a;
            --green-800: #166534;

            --indigo-500: #6366f1;
            --purple-200: #e9d5ff;
            --purple-500: #a855f7;
            --purple-600: #9333ea;
            --red-500: #ef4444;
            --orange-50: #fff7ed;
            --orange-600: #ea580c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--slate-800);
            line-height: 1.5;
            margin: 0;
            padding: 2rem;
        }

        /* Layout */
        .container {
            max-width: 64rem;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--slate-200);
            padding-bottom: 1rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #d95f0e;
            margin: 0;
        }

        .header p {
            font-size: 0.875rem;
            color: var(--slate-500);
            margin-top: 0.5rem;
        }

        /* Panels */
        .panel {
            background-color: var(--bg-card);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--slate-100);
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--slate-700);
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--slate-100);
            padding-bottom: 0.5rem;
        }

        /* Forms */
        .label-sm {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--slate-500);
            margin-bottom: 0.25rem;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--slate-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: var(--slate-50);
            color: var(--slate-700);
            font-weight: 500;
            box-sizing: border-box;
            outline: none;
        }

        .form-control:focus {
            outline: 2px solid var(--blue-600);
            outline-offset: 1px;
            border-color: var(--blue-600);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .input-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            align-items: end;
        }

        /* Navigation Header */
        .top-nav {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--slate-200);
            padding: 1rem 2rem;
            margin: -2rem -2rem 2rem -2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-nav a {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: var(--slate-800);
            font-weight: 600;
            font-size: 1rem;
            transition: color 0.2s;
        }

        .top-nav a:hover {
            color: #d95f0e;
        }

        .top-nav img {
            height: 18px;
            width: 18px;
        }

        /* Location Tabs */
        .location-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .location-tab {
            padding: 0.5rem 1.25rem;
            border: 2px solid var(--slate-200);
            border-radius: 9999px;
            background-color: var(--bg-card);
            color: var(--slate-600);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .location-tab:hover {
            border-color: var(--blue-500);
            color: var(--blue-700);
            background-color: var(--blue-50);
        }

        .location-tab.active {
            border-color: var(--blue-600);
            background-color: var(--blue-600);
            color: white;
        }

        .location-tab .tab-flag {
            font-size: 1rem;
        }

        /* Results Table */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        .results-table th {
            background-color: var(--slate-100);
            color: var(--slate-700);
            font-weight: 600;
            padding: 0.75rem;
            text-align: left;
            border: 1px solid var(--slate-200);
        }

        .results-table td {
            padding: 0.75rem;
            border: 1px solid var(--slate-200);
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-weight: 500;
        }

        .results-table tbody tr:hover {
            background-color: var(--slate-50);
        }

        .results-table .row-label {
            font-weight: 700;
            text-align: left;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--slate-50);
        }

        .currency-header {
            text-align: center;
            font-weight: 700;
        }

        .currency-value {
            text-align: right;
        }

        .value-delta {
            display: block;
            font-size: 0.7rem;
            color: var(--orange-600);
            font-weight: 600;
            margin-top: 0.25rem;
        }

        .value-delta.positive {
            color: var(--green-600);
        }

        .value-delta.negative {
            color: var(--red-500);
        }

        /* Tax Breakdown */
        .tax-breakdown {
            background-color: var(--blue-50);
            border: 1px solid var(--blue-100);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .tax-breakdown h3 {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--blue-900);
            margin: 0 0 0.75rem 0;
        }

        .tax-bracket {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: white;
            border-radius: 0.375rem;
            font-size: 0.75rem;
        }

        .tax-bracket-label {
            color: var(--slate-700);
            font-weight: 600;
        }

        .tax-bracket-amount {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            color: var(--blue-700);
            font-weight: 700;
        }

        .tax-layer-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--slate-600);
            margin: 0.75rem 0 0.5rem 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tax-layer-title:first-child {
            margin-top: 0;
        }

        .effective-rate {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--blue-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            color: var(--blue-900);
        }

        .effective-rate-value {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-size: 1.25rem;
        }

        /* Utilities */
        .hidden {
            display: none;
        }

        .text-center {
            text-align: center;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .top-nav {
                padding: 1rem;
                margin: -1rem -1rem 1rem -1rem;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .results-table {
                font-size: 0.8rem;
            }

            .results-table thead {
                display: none;
            }

            .results-table tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid var(--slate-200);
                border-radius: 0.5rem;
                overflow: hidden;
            }

            .results-table tbody td {
                display: flex;
                justify-content: space-between;
                align-items: baseline;
                padding: 0.5rem 0.75rem;
                border: none;
                border-bottom: 1px solid var(--slate-100);
            }

            .results-table tbody td:last-child {
                border-bottom: none;
            }

            .results-table tbody td.row-label {
                background-color: var(--slate-100);
                font-weight: 700;
                display: block;
                padding: 0.5rem 0.75rem;
            }

            .results-table tbody td.currency-value::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--slate-600);
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            }

            .location-tabs {
                gap: 0.375rem;
            }

            .location-tab {
                padding: 0.4rem 0.75rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="container">

    <nav class="top-nav">
        <a href="../index.html">
            <img src="../favicon.ico" alt="Home">
            Arthur Douillard
        </a>
        <a href="../tools/index.html">Tools</a>
    </nav>

    <header class="header">
        <h1>Tax Calculator</h1>
        <p>Calculate income tax for different locations with automatic currency conversion</p>
        <p id="ratesStatus" style="font-size: 0.75rem; color: var(--slate-400); margin-top: 0.25rem;">Loading exchange rates...</p>
    </header>

    <!-- Location Tabs -->
    <div class="location-tabs" id="locationTabs">
        <button class="location-tab active" data-location="london">
            <span class="tab-flag">&#127468;&#127463;</span> London
        </button>
        <button class="location-tab" data-location="paris">
            <span class="tab-flag">&#127467;&#127479;</span> Paris
        </button>
        <button class="location-tab" data-location="nyc">
            <span class="tab-flag">&#127482;&#127480;</span> New York City
        </button>
        <button class="location-tab" data-location="sf">
            <span class="tab-flag">&#127482;&#127480;</span> San Francisco
        </button>
    </div>

    <!-- Input Panel -->
    <div class="panel">
        <h2 class="section-title">Income Details</h2>

        <div class="input-row">
            <div class="form-group">
                <label class="label-sm">Annual Income</label>
                <input type="text" id="incomeInput" class="form-control" inputmode="numeric" placeholder="50,000" value="50,000">
                <div style="margin-top: 0.75rem;">
                    <label class="label-sm" style="color: var(--orange-600); font-size: 0.7rem;">Compare with New Income (optional)</label>
                    <input type="text" id="compareInput" class="form-control" inputmode="numeric" placeholder="Enter new income to compare" style="font-size: 0.8rem; padding: 0.4rem;">
                    <div style="font-size: 0.65rem; color: var(--slate-400); margin-top: 0.25rem;">Leave empty to hide comparison</div>
                </div>
            </div>

            <div class="form-group">
                <label class="label-sm">Currency</label>
                <select id="currencySelect" class="form-control">
                    <option value="USD">$ USD (US Dollar)</option>
                    <option value="GBP">&pound; GBP (British Pound)</option>
                    <option value="EUR">&euro; EUR (Euro)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="panel" id="resultsPanel">
        <h2 class="section-title" id="resultsSectionTitle">Tax Calculation Results</h2>

        <table class="results-table">
            <thead>
                <tr>
                    <th></th>
                    <th class="currency-header">GBP (&pound;)</th>
                    <th class="currency-header">USD ($)</th>
                    <th class="currency-header">EUR (&euro;)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="row-label">Annual Pre-Tax</td>
                    <td class="currency-value" id="preTaxGBP" data-label="GBP (£)">-</td>
                    <td class="currency-value" id="preTaxUSD" data-label="USD ($)">-</td>
                    <td class="currency-value" id="preTaxEUR" data-label="EUR (€)">-</td>
                </tr>
                <tr>
                    <td class="row-label">Annual Tax</td>
                    <td class="currency-value" id="taxGBP" data-label="GBP (£)">-</td>
                    <td class="currency-value" id="taxUSD" data-label="USD ($)">-</td>
                    <td class="currency-value" id="taxEUR" data-label="EUR (€)">-</td>
                </tr>
                <tr>
                    <td class="row-label">Annual Post-Tax</td>
                    <td class="currency-value" id="postTaxGBP" data-label="GBP (£)">-</td>
                    <td class="currency-value" id="postTaxUSD" data-label="USD ($)">-</td>
                    <td class="currency-value" id="postTaxEUR" data-label="EUR (€)">-</td>
                </tr>
                <tr>
                    <td class="row-label">Monthly Post-Tax</td>
                    <td class="currency-value" id="monthlyGBP" data-label="GBP (£)">-</td>
                    <td class="currency-value" id="monthlyUSD" data-label="USD ($)">-</td>
                    <td class="currency-value" id="monthlyEUR" data-label="EUR (€)">-</td>
                </tr>
                <tr>
                    <td class="row-label">Daily Post-Tax</td>
                    <td class="currency-value" id="dailyGBP" data-label="GBP (£)">-</td>
                    <td class="currency-value" id="dailyUSD" data-label="USD ($)">-</td>
                    <td class="currency-value" id="dailyEUR" data-label="EUR (€)">-</td>
                </tr>
            </tbody>
        </table>

        <!-- Tax Breakdown -->
        <div class="tax-breakdown">
            <h3 id="taxBreakdownTitle">Tax Breakdown</h3>
            <div id="taxBrackets"></div>
            <div class="effective-rate">
                <span>Effective Tax Rate</span>
                <span class="effective-rate-value" id="effectiveRate">0.0%</span>
            </div>
        </div>
    </div>

<script>
    // ==================== EXCHANGE RATES ====================
    const EXCHANGE_RATES = {
        'GBP': 1.0,
        'USD': 1.27,
        'EUR': 1.20
    };

    let ratesLastUpdated = null;

    // ==================== LOCATION TAX CONFIGS ====================
    const LOCATIONS = {
        london: {
            name: 'London, UK',
            localCurrency: 'GBP',
            taxLayers: [
                {
                    name: 'Income Tax',
                    brackets: [
                        { limit: 12570, rate: 0.00, name: 'Personal Allowance' },
                        { limit: 50270, rate: 0.20, name: 'Basic Rate' },
                        { limit: 125140, rate: 0.40, name: 'Higher Rate' },
                        { limit: Infinity, rate: 0.45, name: 'Additional Rate' }
                    ]
                },
                {
                    name: 'National Insurance',
                    brackets: [
                        { limit: 12570, rate: 0.00, name: 'NI Threshold' },
                        { limit: 50270, rate: 0.08, name: 'Main Rate' },
                        { limit: Infinity, rate: 0.02, name: 'Upper Rate' }
                    ]
                }
            ]
        },
        paris: {
            name: 'Paris, France',
            localCurrency: 'EUR',
            taxLayers: [
                {
                    name: 'Income Tax (Imp\u00f4t sur le revenu)',
                    brackets: [
                        { limit: 11294, rate: 0.00, name: 'Tranche 1' },
                        { limit: 28797, rate: 0.11, name: 'Tranche 2 (11%)' },
                        { limit: 82341, rate: 0.30, name: 'Tranche 3 (30%)' },
                        { limit: 177106, rate: 0.41, name: 'Tranche 4 (41%)' },
                        { limit: Infinity, rate: 0.45, name: 'Tranche 5 (45%)' }
                    ]
                },
                {
                    name: 'Social Contributions (CSG/CRDS)',
                    // Simplified: ~9.7% flat on gross salary for employees
                    brackets: [
                        { limit: Infinity, rate: 0.097, name: 'CSG + CRDS (9.7%)' }
                    ]
                }
            ]
        },
        nyc: {
            name: 'New York City',
            localCurrency: 'USD',
            taxLayers: [
                {
                    name: 'Federal Income Tax',
                    brackets: [
                        { limit: 11600, rate: 0.10, name: '10% Bracket' },
                        { limit: 47150, rate: 0.12, name: '12% Bracket' },
                        { limit: 100525, rate: 0.22, name: '22% Bracket' },
                        { limit: 191950, rate: 0.24, name: '24% Bracket' },
                        { limit: 243725, rate: 0.32, name: '32% Bracket' },
                        { limit: 609350, rate: 0.35, name: '35% Bracket' },
                        { limit: Infinity, rate: 0.37, name: '37% Bracket' }
                    ]
                },
                {
                    name: 'NY State Tax',
                    brackets: [
                        { limit: 8500, rate: 0.04, name: '4% Bracket' },
                        { limit: 11700, rate: 0.045, name: '4.5% Bracket' },
                        { limit: 13900, rate: 0.0525, name: '5.25% Bracket' },
                        { limit: 80650, rate: 0.055, name: '5.5% Bracket' },
                        { limit: 215400, rate: 0.06, name: '6% Bracket' },
                        { limit: 1077550, rate: 0.0685, name: '6.85% Bracket' },
                        { limit: 5000000, rate: 0.0965, name: '9.65% Bracket' },
                        { limit: 25000000, rate: 0.103, name: '10.3% Bracket' },
                        { limit: Infinity, rate: 0.109, name: '10.9% Bracket' }
                    ]
                },
                {
                    name: 'NYC City Tax',
                    brackets: [
                        { limit: 12000, rate: 0.03078, name: '3.078% Bracket' },
                        { limit: 25000, rate: 0.03762, name: '3.762% Bracket' },
                        { limit: 50000, rate: 0.03819, name: '3.819% Bracket' },
                        { limit: Infinity, rate: 0.03876, name: '3.876% Bracket' }
                    ]
                },
                {
                    name: 'FICA (Social Security + Medicare)',
                    brackets: [
                        { limit: 168600, rate: 0.0765, name: 'SS (6.2%) + Medicare (1.45%)' },
                        { limit: Infinity, rate: 0.0145, name: 'Medicare only (1.45%)' }
                    ]
                }
            ]
        },
        sf: {
            name: 'San Francisco',
            localCurrency: 'USD',
            taxLayers: [
                {
                    name: 'Federal Income Tax',
                    brackets: [
                        { limit: 11600, rate: 0.10, name: '10% Bracket' },
                        { limit: 47150, rate: 0.12, name: '12% Bracket' },
                        { limit: 100525, rate: 0.22, name: '22% Bracket' },
                        { limit: 191950, rate: 0.24, name: '24% Bracket' },
                        { limit: 243725, rate: 0.32, name: '32% Bracket' },
                        { limit: 609350, rate: 0.35, name: '35% Bracket' },
                        { limit: Infinity, rate: 0.37, name: '37% Bracket' }
                    ]
                },
                {
                    name: 'California State Tax',
                    brackets: [
                        { limit: 10412, rate: 0.01, name: '1% Bracket' },
                        { limit: 24684, rate: 0.02, name: '2% Bracket' },
                        { limit: 38959, rate: 0.04, name: '4% Bracket' },
                        { limit: 54081, rate: 0.06, name: '6% Bracket' },
                        { limit: 68350, rate: 0.08, name: '8% Bracket' },
                        { limit: 349137, rate: 0.093, name: '9.3% Bracket' },
                        { limit: 418961, rate: 0.103, name: '10.3% Bracket' },
                        { limit: 698271, rate: 0.113, name: '11.3% Bracket' },
                        { limit: 1000000, rate: 0.123, name: '12.3% Bracket' },
                        { limit: Infinity, rate: 0.133, name: '13.3% (Mental Health Surtax)' }
                    ]
                },
                {
                    name: 'CA SDI (State Disability Insurance)',
                    brackets: [
                        { limit: Infinity, rate: 0.011, name: 'SDI (1.1%)' }
                    ]
                },
                {
                    name: 'FICA (Social Security + Medicare)',
                    brackets: [
                        { limit: 168600, rate: 0.0765, name: 'SS (6.2%) + Medicare (1.45%)' },
                        { limit: Infinity, rate: 0.0145, name: 'Medicare only (1.45%)' }
                    ]
                }
            ]
        }
    };

    let activeLocation = 'london';

    // ==================== UTILITIES ====================

    function formatCurrency(amount, symbol) {
        if (symbol === undefined) symbol = '';
        const formatted = amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        return symbol ? symbol + formatted : formatted;
    }

    function parseFormattedNumber(str) {
        if (!str) return 0;
        return parseFloat(str.replace(/,/g, '')) || 0;
    }

    function formatInputWithCommas(input) {
        var cursorPos = input.selectionStart;
        var oldValue = input.value;
        var oldCommasBefore = (oldValue.substring(0, cursorPos).match(/,/g) || []).length;

        // Strip non-numeric except decimal point
        var raw = oldValue.replace(/[^0-9.]/g, '');
        // Only allow one decimal point
        var parts = raw.split('.');
        if (parts.length > 2) raw = parts[0] + '.' + parts.slice(1).join('');

        // Format integer part with commas
        parts = raw.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        var formatted = parts.join('.');

        input.value = formatted;

        // Adjust cursor position
        var newCommasBefore = (formatted.substring(0, cursorPos + (formatted.length - oldValue.length)).match(/,/g) || []).length;
        var newPos = cursorPos + (newCommasBefore - oldCommasBefore);
        input.setSelectionRange(newPos, newPos);
    }

    function convertToLocal(amount, fromCurrency, localCurrency) {
        // Convert from input currency to local currency via GBP as base
        const amountInGBP = amount / EXCHANGE_RATES[fromCurrency];
        return amountInGBP * EXCHANGE_RATES[localCurrency];
    }

    function convertFromLocal(amount, localCurrency, toCurrency) {
        const amountInGBP = amount / EXCHANGE_RATES[localCurrency];
        return amountInGBP * EXCHANGE_RATES[toCurrency];
    }

    // ==================== TAX CALCULATION ====================

    function calculateBracketTax(income, brackets) {
        let totalTax = 0;
        let previousLimit = 0;
        const breakdown = [];

        for (let i = 0; i < brackets.length; i++) {
            const bracket = brackets[i];
            const taxableInThisBracket = Math.min(income, bracket.limit) - previousLimit;

            if (taxableInThisBracket > 0) {
                const taxInThisBracket = taxableInThisBracket * bracket.rate;
                totalTax += taxInThisBracket;

                breakdown.push({
                    name: bracket.name,
                    rate: bracket.rate,
                    taxableAmount: taxableInThisBracket,
                    taxAmount: taxInThisBracket
                });

                if (income <= bracket.limit) break;
            }

            previousLimit = bracket.limit;
        }

        return { totalTax, breakdown };
    }

    function calculateTax(incomeLocal, location) {
        const config = LOCATIONS[location];
        let totalTax = 0;
        const layerResults = [];

        for (const layer of config.taxLayers) {
            const result = calculateBracketTax(incomeLocal, layer.brackets);
            totalTax += result.totalTax;
            layerResults.push({
                name: layer.name,
                totalTax: result.totalTax,
                breakdown: result.breakdown
            });
        }

        const effectiveRate = incomeLocal > 0 ? (totalTax / incomeLocal) * 100 : 0;

        return {
            totalTax,
            layerResults,
            effectiveRate,
            postTax: incomeLocal - totalTax
        };
    }

    // ==================== UI UPDATE ====================

    function updateCalculations() {
        const incomeInput = parseFormattedNumber(document.getElementById('incomeInput').value);
        const compareInput = parseFormattedNumber(document.getElementById('compareInput').value);
        const inputCurrency = document.getElementById('currencySelect').value;
        const config = LOCATIONS[activeLocation];
        const localCurrency = config.localCurrency;
        const localSymbol = localCurrency === 'GBP' ? '\u00a3' : (localCurrency === 'USD' ? '$' : '\u20ac');

        // Convert input to the location's local currency
        const incomeLocal = convertToLocal(incomeInput, inputCurrency, localCurrency);
        const compareLocal = compareInput > 0 ? convertToLocal(compareInput, inputCurrency, localCurrency) : 0;

        // Calculate tax in local currency
        const taxResult = calculateTax(incomeLocal, activeLocation);
        const compareTaxResult = compareLocal > 0 ? calculateTax(compareLocal, activeLocation) : null;

        // Convert results to GBP for cross-currency display
        const incomeGBP = incomeLocal / EXCHANGE_RATES[localCurrency];
        const taxGBP = taxResult.totalTax / EXCHANGE_RATES[localCurrency];
        const postTaxGBP = taxResult.postTax / EXCHANGE_RATES[localCurrency];

        // Update table for all three currencies
        ['GBP', 'USD', 'EUR'].forEach(function(curr) {
            const symbol = curr === 'GBP' ? '\u00a3' : (curr === 'USD' ? '$' : '\u20ac');

            const preTax = incomeGBP * EXCHANGE_RATES[curr];
            const tax = taxGBP * EXCHANGE_RATES[curr];
            const postTax = postTaxGBP * EXCHANGE_RATES[curr];
            const monthly = postTax / 12;
            const daily = postTax / 365;

            let preTaxHTML = formatCurrency(preTax, symbol);
            let taxHTML = formatCurrency(tax, symbol);
            let postTaxHTML = formatCurrency(postTax, symbol);
            let monthlyHTML = formatCurrency(monthly, symbol);
            let dailyHTML = formatCurrency(daily, symbol);

            if (compareTaxResult) {
                const compareGBP = compareLocal / EXCHANGE_RATES[localCurrency];
                const compareTaxGBPVal = compareTaxResult.totalTax / EXCHANGE_RATES[localCurrency];
                const comparePostTaxGBPVal = compareTaxResult.postTax / EXCHANGE_RATES[localCurrency];

                const comparePreTax = compareGBP * EXCHANGE_RATES[curr];
                const compareTax = compareTaxGBPVal * EXCHANGE_RATES[curr];
                const comparePostTax = comparePostTaxGBPVal * EXCHANGE_RATES[curr];
                const compareMonthly = comparePostTax / 12;
                const compareDaily = comparePostTax / 365;

                var formatDelta = function(delta) {
                    const sign = delta >= 0 ? '+' : '-';
                    const className = delta > 0 ? 'positive' : (delta < 0 ? 'negative' : '');
                    return '<span class="value-delta ' + className + '">' + sign + formatCurrency(Math.abs(delta), symbol) + '</span>';
                };

                preTaxHTML += formatDelta(comparePreTax - preTax);
                taxHTML += formatDelta(compareTax - tax);
                postTaxHTML += formatDelta(comparePostTax - postTax);
                monthlyHTML += formatDelta(compareMonthly - monthly);
                dailyHTML += formatDelta(compareDaily - daily);
            }

            document.getElementById('preTax' + curr).innerHTML = preTaxHTML;
            document.getElementById('tax' + curr).innerHTML = taxHTML;
            document.getElementById('postTax' + curr).innerHTML = postTaxHTML;
            document.getElementById('monthly' + curr).innerHTML = monthlyHTML;
            document.getElementById('daily' + curr).innerHTML = dailyHTML;
        });

        // Update tax breakdown with layers
        const taxBracketsDiv = document.getElementById('taxBrackets');
        taxBracketsDiv.innerHTML = '';

        taxResult.layerResults.forEach(function(layer) {
            const layerTitle = document.createElement('div');
            layerTitle.className = 'tax-layer-title';
            layerTitle.textContent = layer.name;
            taxBracketsDiv.appendChild(layerTitle);

            layer.breakdown.forEach(function(bracket) {
                if (bracket.taxableAmount > 0) {
                    const bracketDiv = document.createElement('div');
                    bracketDiv.className = 'tax-bracket';

                    const rateText = bracket.rate === 0
                        ? 'Tax-free'
                        : (bracket.rate * 100).toFixed(2).replace(/\.?0+$/, '') + '% on ' + localSymbol + formatCurrency(bracket.taxableAmount, '');

                    bracketDiv.innerHTML =
                        '<span class="tax-bracket-label">' + bracket.name + ': ' + rateText + '</span>' +
                        '<span class="tax-bracket-amount">' + localSymbol + formatCurrency(bracket.taxAmount, '') + '</span>';

                    taxBracketsDiv.appendChild(bracketDiv);
                }
            });
        });

        // Update effective rate
        document.getElementById('effectiveRate').textContent = taxResult.effectiveRate.toFixed(1) + '%';

        // Update titles
        document.getElementById('taxBreakdownTitle').textContent = config.name + ' Tax Breakdown';
        document.getElementById('resultsSectionTitle').textContent = config.name + ' \u2014 Tax Calculation Results';
    }

    // ==================== TAB SWITCHING ====================

    function switchLocation(location) {
        activeLocation = location;

        // Update tab UI
        document.querySelectorAll('.location-tab').forEach(function(tab) {
            tab.classList.remove('active');
            if (tab.getAttribute('data-location') === location) {
                tab.classList.add('active');
            }
        });

        // Recalculate (inputs are preserved since we don't touch them)
        updateCalculations();
    }

    // ==================== EVENT LISTENERS ====================

    document.querySelectorAll('.location-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            switchLocation(this.getAttribute('data-location'));
        });
    });

    document.getElementById('incomeInput').addEventListener('input', function() {
        formatInputWithCommas(this);
        updateCalculations();
    });
    document.getElementById('compareInput').addEventListener('input', function() {
        formatInputWithCommas(this);
        updateCalculations();
    });
    document.getElementById('currencySelect').addEventListener('change', updateCalculations);

    // ==================== FETCH LIVE RATES ====================

    function fetchLiveRates() {
        const statusEl = document.getElementById('ratesStatus');
        statusEl.textContent = 'Loading live exchange rates...';
        statusEl.style.color = 'var(--slate-400)';

        fetch('https://api.frankfurter.app/latest?from=GBP&to=USD,EUR')
            .then(function(response) {
                if (!response.ok) throw new Error('API request failed');
                return response.json();
            })
            .then(function(data) {
                EXCHANGE_RATES.USD = data.rates.USD;
                EXCHANGE_RATES.EUR = data.rates.EUR;
                ratesLastUpdated = new Date(data.date);

                statusEl.textContent = 'Live exchange rates updated: ' + data.date + ' (1 GBP = ' + data.rates.USD.toFixed(3) + ' USD, ' + data.rates.EUR.toFixed(3) + ' EUR)';
                statusEl.style.color = 'var(--green-600)';

                updateCalculations();
            })
            .catch(function(error) {
                console.error('Failed to fetch exchange rates:', error);
                statusEl.textContent = 'Using approximate exchange rates (live rates unavailable)';
                statusEl.style.color = 'var(--orange-600)';

                updateCalculations();
            });
    }

    // Init
    fetchLiveRates();
</script>

</body>
</html>
